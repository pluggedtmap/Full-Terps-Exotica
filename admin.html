<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Big Clouds</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #050505;
            color: #ffffff;
            /* Prevent pull-to-refresh on mobile */
            overscroll-behavior-y: none;
        }

        /* Glassmorphism utilities */
        .glass-panel {
            background: rgba(30, 30, 35, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .input-dark {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }

        .input-dark:focus {
            background: rgba(255, 255, 255, 0.1);
            border-color: #ef4444;
            /* Red Highlight */
            outline: none;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        .btn-primary {
            background: #ef4444;
            /* Red Highlight */
            color: white;
            font-weight: bold;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #dc2626;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.4);
        }

        .nav-tab {
            padding: 0.75rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #9ca3af;
            border-bottom-width: 2px;
            border-color: transparent;
            transition-property: color, border-color, background-color, transform;
            transition-duration: 200ms;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: white;
        }

        .nav-tab.active {
            border-radius: 4px;
            color: #ef4444;
            /* Highlight active */
            border-bottom-color: #ef4444;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        /* Mobile specific scroll tweaks */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Custom Mobile Scroll for Modal */
        .custom-scroll {
            scrollbar-width: thin;
            scrollbar-color: #333 transparent;
        }
    </style>
</head>

<body class="flex flex-col h-screen overflow-hidden text-sm md:text-base">

    <!-- LOGIN OVERLAY -->
    <div id="login-overlay" class="fixed inset-0 z-[100] bg-black flex items-center justify-center p-4">
        <div class="glass-panel p-8 rounded-3xl shadow-2xl w-full max-w-md text-center border border-white/10">
            <div
                class="w-32 h-32 rounded-full flex items-center justify-center mx-auto mb-6 p-1 border border-white/10 bg-black/50 backdrop-blur-md shadow-2xl overflow-hidden">
                <img src="https://raw.githubusercontent.com/pluggedtmap/BigClouds/main/photo_2026-02-01_19-41-55.jpg"
                    class="w-full h-full object-cover">
            </div>
            <h2 class="text-2xl font-bold text-white mb-2">Admin Big Clouds</h2>
            <p class="text-gray-400 mb-8 text-sm">Acc√®s Administrateur</p>
            <input type="password" id="login-password"
                class="w-full input-dark rounded-xl px-4 py-4 text-white mb-4 text-center tracking-widest text-lg"
                placeholder="Mot de passe">
            <button id="login-btn"
                class="w-full btn-primary py-4 rounded-xl transition-transform active:scale-95 text-lg">CONNEXION</button>
            <p id="login-error" class="text-red-500 mt-4 hidden text-sm"><i
                    class="fas fa-exclamation-circle mr-2"></i>Mot de passe incorrect</p>
        </div>
    </div>

    <!-- HEADER / NAVIGATION MOBILE FRIENDLY -->
    <header id="main-editor-header" class="glass-panel z-10 hidden border-b border-white/5 shrink-0">
        <nav class="w-full px-2 md:px-4 flex justify-between items-center h-16">

            <!-- Scrollable Nav Items -->
            <div class="flex items-center gap-2 overflow-x-auto hide-scrollbar flex-1 mr-2 pl-1">
                <a href="index.html"
                    class="text-xl font-bold text-white flex items-center gap-2 mr-2 hover:opacity-80 transition-opacity shrink-0">
                    <div class="w-8 h-8 rounded-lg bg-[#ef4444] flex items-center justify-center text-xs">AD</div>
                </a>

                <button id="nav-orders" class="nav-tab active flex items-center gap-2"
                    onclick="showPage('page-orders')">
                    <i class="fas fa-shopping-bag"></i><span class="hidden sm:inline">Commandes</span>
                </button>
                <button id="nav-clients" class="nav-tab flex items-center gap-2" onclick="showPage('page-clients')">
                    <i class="fas fa-chart-line"></i><span class="hidden sm:inline">Stats</span>
                </button>
                <button id="nav-loyalty" class="nav-tab flex items-center gap-2" onclick="showPage('page-loyalty')">
                    <i class="fas fa-gift"></i><span class="hidden sm:inline">Fid√©lit√©</span>
                </button>
                <button id="nav-produits" class="nav-tab flex items-center gap-2" onclick="showPage('page-produits')">
                    <i class="fas fa-cubes"></i><span class="hidden sm:inline">Produits</span>
                </button>
                <button id="nav-categories" class="nav-tab flex items-center gap-2"
                    onclick="showPage('page-categories')">
                    <i class="fas fa-layer-group"></i><span class="hidden sm:inline">Cat√©gories</span>
                </button>
                <button id="nav-uploads" class="nav-tab flex items-center gap-2" onclick="showPage('page-uploads')">
                    <i class="fas fa-images"></i><span class="hidden sm:inline">Galerie</span>
                </button>
                <button id="nav-contact" class="nav-tab flex items-center gap-2" onclick="showPage('page-contact')">
                    <i class="fas fa-sliders-h"></i><span class="hidden sm:inline">R√©glages</span>
                </button>
            </div>

            <!-- Actions Right -->
            <div class="flex items-center gap-2 shrink-0 pr-1">
                <button onclick="saveSettings()"
                    class="bg-green-600 hover:bg-green-500 text-white w-9 h-9 md:w-auto md:h-auto md:px-4 md:py-2 rounded-lg font-bold text-sm transition-all shadow-lg flex items-center justify-center"
                    title="Sauvegarder">
                    <i class="fas fa-save md:mr-2"></i><span class="hidden md:inline">Save</span>
                </button>
                <button onclick="openPreview()"
                    class="bg-purple-600/20 hover:bg-purple-600/40 text-purple-300 w-9 h-9 md:w-auto md:h-auto md:px-3 md:py-2 rounded-lg font-bold text-sm transition-all flex items-center justify-center"
                    title="Aper√ßu Mobile">
                    <i class="fas fa-mobile-alt md:mr-2"></i><span class="hidden md:inline">Aper√ßu</span>
                </button>
                <button onclick="logout()" class="text-gray-400 hover:text-white p-2">
                    <i class="fas fa-power-off text-lg"></i>
                </button>
            </div>
        </nav>
    </header>


    <main id="main-content" class="flex-1 overflow-y-auto p-2 md:p-8 hidden relative pb-24 md:pb-8">
        <!-- Background elements -->
        <div class="fixed top-20 left-20 w-64 h-64 bg-red-500/10 rounded-full blur-3xl pointer-events-none z-[-1]">
        </div>
        <div
            class="fixed bottom-20 right-20 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl pointer-events-none z-[-1]">
        </div>

        <div class="max-w-6xl mx-auto">

            <!-- PAGE ORDERS -->
            <section id="page-orders" class="page-section">
                <div class="glass-panel p-4 md:p-6 rounded-2xl relative overflow-hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-white">Commandes</h2>
                            <p class="text-gray-400 text-sm">Suivi des ventes</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                            <button onclick="deleteAllOrders()"
                                class="flex-1 md:flex-none text-red-500 hover:text-red-400 text-sm font-bold bg-red-500/10 px-4 py-3 md:py-2 rounded-lg border border-red-500/20 hover:bg-red-500/20 transition-all">
                                <i class="fas fa-trash mr-2"></i>Tout Supprimer
                            </button>
                            <button onclick="loadOrders()"
                                class="flex-1 md:flex-none text-[#ef4444] hover:text-white text-sm font-bold bg-red-500/10 px-4 py-3 md:py-2 rounded-lg border border-red-500/20 hover:bg-red-500/20 transition-all">
                                <i class="fas fa-sync-alt mr-2"></i>Actualiser
                            </button>
                        </div>
                    </div>
                    <div id="orders-list" class="space-y-4"></div>
                </div>
            </section>

            <!-- PAGE CLIENTS (STATS RE-LABEL) -->
            <section id="page-clients" class="page-section hidden">
                <div class="glass-panel p-6 rounded-2xl mb-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-line text-green-400"></i> Performance Journali√®re
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="text-xs text-gray-500 border-b border-white/10 uppercase">
                                    <th class="p-3">Date</th>
                                    <th class="p-3">Commandes</th>
                                    <th class="p-3 text-right">Chiffre d'Affaires</th>
                                </tr>
                            </thead>
                            <tbody id="daily-stats-body" class="text-sm">
                                <!-- Rempli par JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- PAGE LOYALTY (NEW) -->
            <section id="page-loyalty" class="page-section hidden">
                <!-- Loyalty Settings Panel -->
                <div class="glass-panel p-4 md:p-6 rounded-2xl mb-6 border border-amber-500/20">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-cog text-amber-500"></i> Param√®tres de Fid√©lit√©
                    </h3>

                    <div class="grid grid-cols-1 gap-4">
                        <!-- Current Config Display -->
                        <div class="p-3 bg-amber-500/10 border border-amber-500/20 rounded-lg flex items-center gap-3">
                            <i class="fas fa-lightbulb text-amber-500 text-xl"></i>
                            <div class="text-sm">
                                <span class="text-white font-bold">Syst√®me simplifi√© :</span>
                                <span class="text-gray-300 ml-2">10 commandes = 1 cadeau au choix</span>
                            </div>
                        </div>

                        <!-- Rewards List Management -->
                        <div class="bg-black/30 p-4 rounded-xl border border-white/5">
                            <div class="flex justify-between items-center mb-3">
                                <label class="text-xs text-gray-400 uppercase font-bold">
                                    <i class="fas fa-gifts text-amber-500 mr-1"></i> R√©compenses Configurables
                                </label>
                                <button onclick="addReward()"
                                    class="px-3 py-1 bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 rounded-lg text-xs font-bold transition border border-amber-500/30">
                                    <i class="fas fa-plus mr-1"></i> Ajouter
                                </button>
                            </div>

                            <div id="rewards-list" class="space-y-2 mb-3 max-h-96 overflow-y-auto">
                                <!-- Rewards will be added here dynamically -->
                            </div>

                            <p class="text-xs text-gray-500 mt-2">
                                <i class="fas fa-info-circle"></i> Maximum 10 r√©compenses. Elles s'afficheront sur la
                                page fid√©lit√© client.
                            </p>
                        </div>

                        <!-- Save Button -->
                        <button onclick="saveLoyaltySettings()"
                            class="w-full px-4 py-3 bg-amber-500/20 hover:bg-amber-500/30 text-amber-400 rounded-lg font-bold transition border border-amber-500/30">
                            <i class="fas fa-save mr-2"></i> Sauvegarder Toute la Configuration
                        </button>
                    </div>
                </div>

                <!-- Users List -->
                <div class="glass-panel p-4 md:p-6 rounded-2xl relative overflow-hidden">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-white">Clients Fid√®les</h2>
                            <p class="text-gray-400 text-sm">Gestion des points clients</p>
                        </div>
                        <button onclick="loadLoyaltyUsers()"
                            class="text-[#ef4444] hover:text-white bg-red-500/10 px-3 py-2 rounded-lg border border-red-500/20">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>

                    <!-- Search Bar -->
                    <div class="mb-4">
                        <div class="relative">
                            <input type="text" id="loyalty-search" placeholder="üîç Rechercher par ID Telegram..."
                                oninput="filterLoyaltyUsers()"
                                class="w-full bg-black/30 border border-white/10 rounded-xl px-4 py-3 pl-10 text-white placeholder-gray-500 focus:border-amber-500/50 outline-none transition">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"></i>
                        </div>
                    </div>

                    <div id="loyalty-list" class="space-y-4"></div>
                </div>
            </section>

            <!-- PAGE PRODUITS -->
            <section id="page-produits" class="page-section hidden">
                <div class="glass-panel p-4 md:p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-xl md:text-2xl font-bold text-white">Catalogue</h2>
                            <p class="text-gray-400 text-sm">Votre menu</p>
                        </div>
                        <button id="add-product-btn"
                            class="bg-[#ef4444] hover:bg-[#dc2626] text-white font-bold py-2 px-4 rounded-xl transition-colors shadow-lg shadow-red-500/20 text-sm md:text-base">
                            <i class="fas fa-plus mr-2"></i>Ajouter
                        </button>
                    </div>
                    <!-- Product Grid: 2 col mobile, adaptable -->
                    <div id="product-list-ui" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-6">
                    </div>
                </div>
            </section>

            <!-- PAGE CATEGORIES -->
            <section id="page-categories" class="page-section hidden">
                <div class="glass-panel p-4 md:p-6 rounded-2xl max-w-2xl mx-auto">
                    <h2 class="text-xl md:text-2xl font-bold text-white mb-2">Cat√©gories</h2>

                    <div class="flex gap-2 mb-6">
                        <input type="text" id="new-category-input"
                            class="w-full input-dark rounded-xl px-4 py-3 text-white"
                            placeholder="Nouvelle cat√©gorie...">
                        <button id="add-category-btn"
                            class="bg-[#ef4444] hover:bg-[#dc2626] text-white font-bold px-4 rounded-xl flex items-center justify-center">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="category-list-ui" class="space-y-3"></div>
                </div>
            </section>

            <!-- PAGE UPLOADS -->
            <section id="page-uploads" class="page-section hidden">
                <div class="glass-panel p-4 md:p-6 rounded-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl md:text-2xl font-bold text-white">Galerie</h2>
                        <button onclick="loadGithubFiles()"
                            class="text-[#ef4444] bg-red-500/10 px-3 py-2 rounded-lg border border-red-500/20">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div id="github-files-list" class="grid grid-cols-3 md:grid-cols-5 gap-3"></div>
                </div>
            </section>

            <!-- PAGE CONTACT -->
            <section id="page-contact" class="page-section hidden">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                    <div class="col-span-2 space-y-4 md:space-y-6">
                        <div class="glass-panel p-4 md:p-6 rounded-2xl">
                            <h3 class="text-lg font-bold text-[#ef4444] mb-4 flex items-center gap-2"><i
                                    class="fas fa-cog"></i> G√©n√©ral</h3>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Nom de
                                        l'App</label>
                                    <input type="text" id="app-title" class="w-full input-dark rounded-lg px-3 py-3">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Vid√©o Hero
                                        (URL)</label>
                                    <input type="text" id="hero-image" class="w-full input-dark rounded-lg px-3 py-3">
                                </div>
                            </div>
                        </div>

                        <div class="glass-panel p-4 md:p-6 rounded-2xl">
                            <h3 class="text-lg font-bold text-[#ef4444] mb-4 flex items-center gap-2"><i
                                    class="fas fa-bullhorn"></i> Annonce</h3>
                            <input type="text" id="banner-text" class="w-full input-dark rounded-lg px-3 py-3"
                                placeholder="Texte d√©filant...">
                        </div>
                    </div>

                    <div class="col-span-1 space-y-4 md:space-y-6">
                        <div class="glass-panel p-4 md:p-6 rounded-2xl text-center">
                            <button onclick="saveSettings()"
                                class="bg-[#ef4444] hover:bg-[#dc2626] text-white font-bold py-4 px-4 rounded-xl w-full shadow-lg shadow-red-500/20 active:scale-95 transition-transform text-lg">
                                <i class="fas fa-save mr-2"></i>SAUVEGARDER
                            </button>
                        </div>
                        <div class="glass-panel p-4 md:p-6 rounded-2xl">
                            <h3 class="font-bold text-white mb-4">S√©curit√©</h3>
                            <input type="password" id="new-admin-password"
                                class="w-full input-dark rounded-lg px-3 py-3 mb-4" placeholder="Nouveau mot de passe">
                            <button onclick="changePassword()"
                                class="w-full bg-white/10 p-3 rounded-lg text-sm text-white hover:bg-white/20">Changer</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- PRODUCT MODAL (FULL SCREEN MOBILE) -->
    <div id="product-modal"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-md">
        <!-- added 'h-full md:h-auto' and 'rounded-none md:rounded-2xl' for mobile fullscreen feel -->
        <div
            class="glass-panel w-full md:max-w-3xl h-full md:max-h-[85vh] flex flex-col z-10 border-0 md:border border-white/10 bg-[#0a0a0f] md:bg-black/90 md:rounded-2xl">

            <!-- Modal Header -->
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-black/40 md:rounded-t-2xl">
                <h2 id="modal-title" class="text-xl font-bold text-white">√âditer</h2>
                <button onclick="closeProductModal()"
                    class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white"><i
                        class="fas fa-times"></i></button>
            </div>

            <!-- Modal Content (Scrollable) -->
            <div class="overflow-y-auto p-4 space-y-5 flex-1 custom-scroll pb-32 md:pb-4">
                <input type="hidden" id="product-id-input">

                <!-- Main Info -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Nom du produit</label>
                        <input type="text" id="modal-name"
                            class="w-full input-dark rounded-xl px-4 py-3 text-lg font-bold">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Cat√©gorie</label>
                            <select id="modal-category"
                                class="w-full input-dark rounded-xl px-3 py-3 bg-[#1a1a1a] appearance-none select-none"></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Farm / Brand</label>
                            <input type="text" id="modal-farm" class="w-full input-dark rounded-xl px-3 py-3">
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Description</label>
                    <textarea id="modal-description"
                        class="w-full input-dark rounded-xl px-4 py-3 h-24 text-sm leading-relaxed"
                        placeholder="D√©tails du produit..."></textarea>

                    <!-- Position Toggle -->
                    <div class="flex gap-2 mt-2">
                        <button type="button" id="desc-pos-up"
                            class="flex-1 bg-white/5 py-3 rounded-lg text-xs text-gray-400 border border-white/5 hover:bg-white/10"
                            onclick="setDescPos('top')">Afficher en Haut</button>
                        <button type="button" id="desc-pos-down"
                            class="flex-1 bg-white/5 py-3 rounded-lg text-xs text-gray-400 border border-white/5 hover:bg-white/10"
                            onclick="setDescPos('bottom')">Afficher en Bas</button>
                        <input type="hidden" id="modal-desc-pos" value="top">
                    </div>
                </div>

                <!-- Badges -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Badge Promo (Optionnel)</label>
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="modal-extraInfo" class="flex-1 input-dark rounded-xl px-3 py-3"
                            placeholder="Ex: TOP SHELF">
                        <div class="w-12 h-full relative overflow-hidden rounded-xl border border-white/10 shrink-0">
                            <input type="color" id="modal-extraInfoColor"
                                class="absolute -top-2 -left-2 w-20 h-20 cursor-pointer p-0" value="#ef4444">
                        </div>
                    </div>
                    <!-- Color presets scrollable -->
                    <div class="flex gap-3 overflow-x-auto pb-2 hide-scrollbar py-1">
                        <button type="button"
                            class="color-btn w-10 h-10 rounded-full border-2 border-transparent shrink-0"
                            style="background-color: #ef4444;" onclick="setBadgeColor('#ef4444', this)"></button>
                        <button type="button"
                            class="color-btn w-10 h-10 rounded-full border-2 border-transparent shrink-0"
                            style="background-color: #f97316;" onclick="setBadgeColor('#f97316', this)"></button>
                        <button type="button"
                            class="color-btn w-10 h-10 rounded-full border-2 border-transparent shrink-0"
                            style="background-color: #eab308;" onclick="setBadgeColor('#eab308', this)"></button>
                        <button type="button"
                            class="color-btn w-10 h-10 rounded-full border-2 border-transparent shrink-0"
                            style="background-color: #22c55e;" onclick="setBadgeColor('#22c55e', this)"></button>
                        <button type="button"
                            class="color-btn w-10 h-10 rounded-full border-2 border-transparent shrink-0"
                            style="background-color: #3b82f6;" onclick="setBadgeColor('#3b82f6', this)"></button>
                        <button type="button"
                            class="color-btn w-10 h-10 rounded-full border-2 border-transparent shrink-0"
                            style="background-color: #a855f7;" onclick="setBadgeColor('#a855f7', this)"></button>
                        <button type="button"
                            class="color-btn w-10 h-10 rounded-full border-2 border-transparent shrink-0"
                            style="background-color: #ec4899;" onclick="setBadgeColor('#ec4899', this)"></button>
                        <button type="button"
                            class="color-btn w-10 h-10 rounded-full border-2 border-transparent shrink-0"
                            style="background-color: #000000;" onclick="setBadgeColor('#000000', this)"></button>
                    </div>
                </div>

                <!-- Prices & Varieties -->
                <div class="space-y-4">
                    <!-- Prices -->
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-gray-300 flex items-center"><i
                                    class="fas fa-tag mr-2 text-[#ef4444]"></i>Prix</span>
                            <button type="button" id="modal-add-price"
                                class="bg-[#ef4444] text-white w-8 h-8 rounded-lg flex items-center justify-center shadow"><i
                                    class="fas fa-plus text-xs"></i></button>
                        </div>
                        <div id="modal-prices-list" class="space-y-3"></div>
                    </div>

                    <!-- Images -->
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-gray-300 flex items-center"><i
                                    class="fas fa-image mr-2 text-[#ef4444]"></i>Images</span>
                            <button type="button" id="modal-add-image"
                                class="bg-[#ef4444] text-white w-8 h-8 rounded-lg flex items-center justify-center shadow"><i
                                    class="fas fa-plus text-xs"></i></button>
                        </div>
                        <div id="modal-images-list" class="space-y-3"></div>
                    </div>

                    <!-- Varieties -->
                    <div class="bg-white/5 p-4 rounded-xl border border-white/10">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-gray-300 flex items-center"><i
                                    class="fas fa-cannabis mr-2 text-[#ef4444]"></i>Vari√©t√©s</span>
                            <button type="button" id="modal-add-variety"
                                class="bg-[#ef4444] text-white w-8 h-8 rounded-lg flex items-center justify-center shadow"><i
                                    class="fas fa-plus text-xs"></i></button>
                        </div>
                        <div id="modal-varieties-list" class="space-y-3"></div>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="modal-delete-btn"
                        class="w-full text-red-500 border border-red-500/30 py-3 rounded-xl hover:bg-red-500/10 transition-colors transform active:scale-95">
                        <i class="fas fa-trash mr-2"></i>Supprimer ce produit
                    </button>
                </div>
            </div>

            <!-- Sticky Footer Actions -->
            <div class="p-4 border-t border-white/10 bg-[#0a0a0f] md:bg-black/40 flex gap-3 z-20 md:rounded-b-2xl">
                <button onclick="closeProductModal()"
                    class="flex-1 bg-white/10 hover:bg-white/20 text-white font-semibold py-3 px-4 rounded-xl transition-colors">Annuler</button>
                <button id="modal-save-btn"
                    class="flex-1 bg-[#ef4444] hover:bg-[#dc2626] text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-red-500/20 active:scale-95 transition-transform text-lg">
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- PREVIEW MODAL -->
    <div id="preview-modal"
        class="hidden fixed inset-0 z-[200] flex items-center justify-center bg-black/90 backdrop-blur-md p-0 md:p-4">
        <div
            class="relative w-full h-full md:w-[380px] md:h-[80vh] bg-black md:rounded-[40px] md:border-8 md:border-gray-800 shadow-2xl overflow-hidden">
            <!-- Notch only on desktop mode -->
            <div
                class="absolute top-0 left-1/2 -translate-x-1/2 w-40 h-7 bg-gray-800 rounded-b-xl z-20 hidden md:block">
            </div>

            <button onclick="closePreview()"
                class="absolute top-4 right-4 z-30 bg-black/50 text-white w-10 h-10 rounded-full flex items-center justify-center backdrop-blur-md border border-white/10">
                <i class="fas fa-times"></i>
            </button>
            <iframe id="preview-iframe" src="" class="w-full h-full bg-[#111] border-0"></iframe>
        </div>
    </div>

    <script>
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);
        let adminToken = null;
        let productsData = {};
        let productsList = [];
        let appSettings = { categories: [], contact: {} };

        // LOGIN
        $('#login-btn').addEventListener('click', async () => {
            const pwd = $('#login-password').value;
            try {
                const res = await fetch('/api/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password: pwd }) });
                const data = await res.json();
                if (data.success) {
                    adminToken = pwd;
                    $('#login-overlay').classList.add('hidden');
                    $('#main-editor-header').classList.remove('hidden');
                    $('#main-content').classList.remove('hidden');
                    initAdmin();
                } else { $('#login-error').classList.remove('hidden'); }
            } catch (e) { alert("Erreur connexion serveur"); }
        });

        function logout() { location.reload(); }

        async function initAdmin() {
            await loadSettings();
            await loadProducts();
            loadOrders();
            // loadClients(); // Will be called when tab is clicked
        }

        window.showPage = (id) => {
            $$('.page-section').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            $$('.nav-tab').forEach(t => t.classList.remove('active'));

            // Map page IDs to Nav IDs
            const map = {
                'page-orders': 'nav-orders',
                'page-clients': 'nav-clients',
                'page-loyalty': 'nav-loyalty',
                'page-produits': 'nav-produits',
                'page-categories': 'nav-categories',
                'page-uploads': 'nav-uploads',
                'page-contact': 'nav-contact'
            };
            if (map[id]) document.getElementById(map[id]).classList.add('active');
            if (id === 'page-uploads') loadGithubFiles();
            if (id === 'page-clients') loadStatsOnly();
            if (id === 'page-loyalty') loadLoyaltyUsers();
        }

        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const json = await res.json();
                if (json.data) { appSettings = { ...appSettings, ...json.data }; if (!appSettings.contact) appSettings.contact = {}; renderSettingsUI(); }
            } catch (e) { console.error(e); }
        }
        async function saveSettings(silent = false) {
            appSettings.appTitle = $('#app-title').value;
            appSettings.bannerText = $('#banner-text').value;
            appSettings.heroImage = $('#hero-image').value;
            try {
                const res = await fetch('/api/settings', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': adminToken }, body: JSON.stringify(appSettings) });
                if (!silent) alert("Param√®tres sauvegard√©s !");
            } catch (e) { alert("Erreur sauvegarde"); }
        }
        async function changePassword() {
            const newPwd = $('#new-admin-password').value;
            if (!newPwd) return;
            try {
                await fetch('/api/change-password', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': adminToken }, body: JSON.stringify({ oldPassword: adminToken, newPassword: newPwd }) });
                alert("Mot de passe modifi√©"); location.reload();
            } catch (e) { alert("Erreur"); }
        }

        // ORDERS (Optimized View)
        async function loadOrders() {
            const list = $('#orders-list');
            list.innerHTML = '<div class="text-center py-10 opacity-50"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';
            try {
                const res = await fetch('/api/orders', { headers: { 'Authorization': adminToken } });
                const json = await res.json();
                list.innerHTML = '';
                if (json.data && json.data.length) {
                    json.data.forEach(o => {
                        const el = document.createElement('div');
                        el.className = 'glass-panel p-4 rounded-xl border border-white/5 flex flex-col gap-3';
                        el.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                     <span class="bg-white/10 px-2 py-1 rounded text-xs font-mono text-gray-400">#${o.id.toString().slice(-4)}</span>
                                     <div class="text-xs text-gray-500 mt-1">${new Date(o.createdAt).toLocaleString()}</div>
                                </div>
                                <span class="text-green-400 font-bold text-lg">${o.total}‚Ç¨</span>
                            </div>
                            
                            <div class="bg-black/30 p-3 rounded-lg text-sm space-y-1">
                                ${o.items.map(i => `<div class="flex justify-between border-b border-white/5 last:border-0 pb-1 last:pb-0">
                                    <span class="text-gray-300">${i.quantity}x ${i.name} ${i.variety}</span>
                                    <span class="text-gray-500 text-xs">${i.weight}</span>
                                </div>`).join('')}
                            </div>

                            ${o.userInfo ? `<div class="text-xs text-gray-400 bg-blue-900/10 p-3 rounded-lg border border-blue-500/10">
                                <div class="font-bold text-blue-300 mb-1"><i class="fas fa-user-circle mr-1"></i>Client</div>
                                <div>${o.userInfo.pseudo || 'Anonyme'}</div>
                                ${o.userInfo.adresse ? `<div>${o.userInfo.adresse}, ${o.userInfo.zip} ${o.userInfo.ville}</div>` : ''}
                                ${o.userInfo.whatsapp ? `<div class="mt-1"><i class="fab fa-whatsapp"></i> ${o.userInfo.whatsapp}</div>` : ''}
                            </div>` : ''}
                            
                            <div class="flex justify-between items-center mt-1">
                                <div class="flex gap-2">
                                     <span class="text-[10px] uppercase tracking-wider bg-white/5 px-2 py-1 rounded border border-white/10">${o.shippingMethod}</span>
                                </div>
                                <button onclick="deleteOrder('${o.id}')" class="text-red-500 p-2 hover:bg-red-500/10 rounded-lg transition"><i class="fas fa-trash"></i></button>
                            </div>
                        `;
                        list.appendChild(el);
                    });
                } else { list.innerHTML = '<div class="text-gray-500 text-center py-10">Aucune commande.</div>'; }
            } catch (e) { list.innerHTML = 'Erreur chargement'; }
        }
        async function deleteOrder(id) { if (confirm("Supprimer?")) await fetch(`/api/orders/${id}`, { method: 'DELETE', headers: { 'Authorization': adminToken } }); loadOrders(); }
        async function deleteAllOrders() { if (confirm("Tout supprimer?")) await fetch(`/api/orders`, { method: 'DELETE', headers: { 'Authorization': adminToken } }); loadOrders(); }

        // CLIENTS & STATS LOGIC
        async function loadStatsOnly() {
            const statsBody = $('#daily-stats-body');
            if (statsBody) statsBody.innerHTML = '<tr><td colspan="3" class="text-center p-4">Chargement...</td></tr>';
            try {
                const res = await fetch('/api/orders?t=' + Date.now(), { headers: { 'Authorization': adminToken } });
                const json = await res.json();
                const dailyStats = {};
                if (json.data) {
                    json.data.forEach(o => {
                        const d = new Date(o.createdAt || o.id);
                        const dateStr = d.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        if (!dailyStats[dateStr]) dailyStats[dateStr] = { count: 0, total: 0 };
                        dailyStats[dateStr].count++;
                        dailyStats[dateStr].total += (parseFloat(o.total) || 0);
                    });
                }
                if (statsBody) {
                    statsBody.innerHTML = '';
                    const parseDate = (str) => { if (!str) return 0; const parts = str.split('/'); return new Date(parts[2], parts[1] - 1, parts[0]).getTime(); };
                    const sortedDates = Object.keys(dailyStats).sort((a, b) => parseDate(b) - parseDate(a));
                    if (sortedDates.length === 0) statsBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 p-4">Pas de donn√©es</td></tr>';
                    sortedDates.forEach(date => {
                        const s = dailyStats[date];
                        const tr = document.createElement('tr');
                        tr.className = 'border-b border-white/5 hover:bg-white/5 transition-colors group';
                        tr.innerHTML = `<td class="p-3 font-mono text-gray-300 group-hover:text-white">${date}</td><td class="p-3 font-bold text-gray-400 group-hover:text-white">${s.count}</td><td class="p-3 text-right font-bold text-green-400">${Number(s.total).toFixed(2)}‚Ç¨</td>`;
                        statsBody.appendChild(tr);
                    });
                }
            } catch (e) { if (statsBody) statsBody.innerHTML = '<tr><td colspan="3">Erreur</td></tr>'; }
        }

        async function loadLoyaltyUsers() {
            const list = $('#loyalty-list');
            if (list) list.innerHTML = '<div class="text-center py-10 opacity-50"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';

            try {
                const res = await fetch('/api/clients?t=' + Date.now(), { headers: { 'Authorization': adminToken } });
                const json = await res.json();

                if (list) {
                    list.innerHTML = '';
                    if (!json.data || json.data.length === 0) {
                        list.innerHTML = '<div class="text-gray-500 text-center py-10">Aucun utilisateur Telegram enregistr√©.</div>';
                    } else {
                        json.data.forEach(c => {
                            const el = document.createElement('div');
                            el.className = 'glass-panel p-4 rounded-xl border border-white/5 flex flex-col gap-3';
                            el.setAttribute('data-user-id', c.id); // For search
                            const safeId = c.id;

                            // Visual Points: 1 Row of 10
                            let pointsHtml = '<div class="flex flex-col gap-1 mt-2 bg-black/20 p-2 rounded-lg border border-white/5">';
                            // Row 1
                            pointsHtml += '<div class="flex gap-1 justify-center">';
                            for (let i = 1; i <= 10; i++) {
                                const active = i <= c.points;
                                const color = active ? 'bg-[#ef4444] shadow-[0_0_8px_rgba(239,68,68,0.6)]' : 'bg-white/5 border border-white/10';
                                pointsHtml += `<div class="flex-1 w-6 h-2 rounded-full ${color} transition-all duration-300"></div>`;
                            }
                            pointsHtml += '</div></div>';

                            el.innerHTML = `
                                <div class="flex justify-between items-start">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-400 border border-blue-500/20">
                                            <i class="fab fa-telegram text-xl"></i>
                                        </div>
                                        <div>
                                            <div class="text-gray-400 text-xs font-mono mb-0.5">ID SECURISE</div>
                                            <div class="font-bold text-white tracking-wider font-mono bg-white/5 px-2 py-0.5 rounded border border-white/10">${safeId}</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-3xl font-black ${c.points >= 5 ? 'text-amber-500 drop-shadow-[0_0_10px_rgba(245,158,11,0.5)]' : 'text-gray-500'}">${c.points}</div>
                                        <div class="text-[9px] text-gray-500 uppercase tracking-widest font-bold">Points</div>
                                    </div>
                                </div>
                                
                                ${pointsHtml}
                                
                                <div class="flex justify-between items-center text-xs text-gray-400 px-1">
                                    <span>Total D√©pens√©:</span>
                                    <span class="text-green-400 font-bold font-mono">${Number(c.totalSpent || 0).toFixed(2)}‚Ç¨</span>
                                </div>

                                <div class="grid grid-cols-2 gap-2 mt-2">
                                     <div class="bg-white/5 rounded-lg p-2 flex items-center justify-between border border-white/5">
                                         <span class="text-[10px] text-gray-500 uppercase font-bold">Ajuster</span>
                                         <div class="flex gap-1">
                                            <button onclick="modifyPoints('${c.id}', 'add', -1)" class="w-8 h-8 rounded bg-black/40 hover:bg-white/10 flex items-center justify-center text-white font-bold transition border border-white/5">-</button>
                                            <button onclick="modifyPoints('${c.id}', 'add', 1)" class="w-8 h-8 rounded bg-black/40 hover:bg-white/10 flex items-center justify-center text-white font-bold transition border border-white/5">+</button>
                                         </div>
                                     </div>
                                     <button onclick="modifyPoints('${c.id}', 'reset')" class="bg-green-500/10 hover:bg-green-500/20 text-green-400 border border-green-500/20 rounded-lg p-2 flex flex-col items-center justify-center transition group">
                                        <i class="fas fa-gift text-lg mb-1 group-hover:scale-110 transition-transform"></i>
                                        <span class="text-[9px] font-bold uppercase">Valider</span>
                                     </button>
                                </div>
                                <button onclick="modifyPoints('${c.id}', 'set', 0)" class="w-full text-center py-2 text-[10px] text-red-500/50 hover:text-red-500 hover:bg-red-500/10 rounded transition mt-1">
                                    <i class="fas fa-trash-alt mr-1"></i> R√©initialiser le client
                                </button>
                            `;
                            list.appendChild(el);
                        });
                    }
                }
            } catch (e) { if (list) list.innerHTML = '<div class="text-red-500 text-center">Erreur de chargement</div>'; }
        }

        async function modifyPoints(userId, action, value) {
            if (!confirm("Confirmer cette action ?")) return;
            try {
                await fetch('/api/clients/points', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': adminToken },
                    body: JSON.stringify({ userId, action, value })
                });
                loadLoyaltyUsers(); // Refresh
            } catch (e) { alert("Erreur modification points"); }
        }

        // REWARDS MANAGEMENT
        let loyaltyRewards = [];

        function addReward() {
            if (loyaltyRewards.length >= 10) {
                alert('‚ö†Ô∏è Maximum 10 r√©compenses atteint');
                return;
            }

            loyaltyRewards.push({
                id: Date.now(),
                points: 5,
                description: ''
            });

            renderRewardsList();
        }

        function removeReward(id) {
            loyaltyRewards = loyaltyRewards.filter(r => r.id !== id);
            renderRewardsList();
        }

        function renderRewardsList() {
            const container = $('#rewards-list');
            if (!container) return;

            container.innerHTML = '';

            if (loyaltyRewards.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm text-center py-4">Aucun cadeau configur√©. Cliquez sur "Ajouter" pour cr√©er vos r√©compenses.</div>';
                return;
            }

            loyaltyRewards.forEach((reward, index) => {
                const el = document.createElement('div');
                el.className = 'flex gap-2 items-center bg-black/30 p-3 rounded-lg border border-white/5';
                el.innerHTML = `
                    <div class="flex-1">
                        <input type="text" 
                            value="${reward.description}" 
                            placeholder="Ex: Livraison gratuite"
                            oninput="loyaltyRewards[${index}].description = this.value"
                            class="w-full bg-white/5 border border-white/10 rounded px-3 py-2 text-white text-sm focus:border-amber-500/50 outline-none placeholder-gray-600">
                    </div>
                    <button onclick="removeReward(${reward.id})" 
                        class="flex-shrink-0 w-8 h-8 bg-red-500/10 hover:bg-red-500/20 text-red-400 rounded flex items-center justify-center transition border border-red-500/20">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                `;
                container.appendChild(el);
            });
        }

        function saveLoyaltySettings() {
            const loyaltyConfig = {
                maxPoints: 20,
                rewards: loyaltyRewards
            };

            // Save to backend API
            fetch('/api/loyalty/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': adminToken
                },
                body: JSON.stringify(loyaltyConfig)
            })
                .then(res => res.json())
                .then(json => {
                    if (json.success) {
                        alert(`‚úÖ Configuration sauvegard√©e!\n${loyaltyRewards.length} r√©compense(s) enregistr√©e(s).`);
                    }
                })
                .catch(e => alert('‚ùå Erreur de sauvegarde'));
        }

        async function loadLoyaltySettings() {
            try {
                const res = await fetch('/api/loyalty/config');
                const json = await res.json();

                if (json.success && json.config) {
                    const config = json.config;
                    loyaltyRewards = Array.isArray(config.rewards) ? config.rewards : [];
                    renderRewardsList();
                }
            } catch (e) {
                console.error('Failed to load loyalty config:', e);
            }
        }

        // Load loyalty settings when page shows loyalty tab
        const originalShowPage = window.showPage;
        window.showPage = (id) => {
            originalShowPage(id);
            if (id === 'page-loyalty') {
                loadLoyaltySettings();
            }
        };

        // Filter/Search loyalty users
        function filterLoyaltyUsers() {
            const searchTerm = $('#loyalty-search').value.toLowerCase().trim();
            const allCards = document.querySelectorAll('#loyalty-list > div');

            allCards.forEach(card => {
                const userId = card.getAttribute('data-user-id') || '';
                if (userId.toLowerCase().includes(searchTerm)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // PRODUCTS UI (Updated Grid)
        async function loadProducts() {
            try { const res = await fetch('/api/products'); const json = await res.json(); productsData = {}; productsList = json.data || []; productsList.forEach(p => productsData[p.id] = p); renderProductUI(); } catch (e) { }
        }

        function renderProductUI() {
            const list = $('#product-list-ui');
            list.innerHTML = '';
            productsList.forEach(p => {
                const el = document.createElement('div');
                el.className = 'glass-panel rounded-xl shadow overflow-hidden flex flex-col relative group product-card border border-white/5';
                el.setAttribute('data-id', p.id);
                let img = (p.images && p.images.length) ? p.images[0] : '';

                el.innerHTML = `
                    <div class="aspect-square bg-gray-900 relative">
                        ${img ? `<img src="${img}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity">` : '<div class="w-full h-full flex items-center justify-center text-gray-700"><i class="fas fa-cannabis text-3xl"></i></div>'}
                        <div class="absolute top-2 right-2 bg-black/60 backdrop-blur px-2 py-0.5 rounded text-[10px] text-white font-bold tracking-wider">${p.category}</div>
                        <div class="absolute top-2 left-2 bg-black/50 w-8 h-8 rounded flex items-center justify-center text-white cursor-move drag-handle z-10"><i class="fas fa-grip-vertical"></i></div>
                    </div>
                    <div class="p-3 flex items-center justify-between gap-2">
                        <h3 class="font-bold text-white text-sm truncate flex-1">${p.name}</h3>
                        <button onclick="openProductModal('${p.id}')" class="w-8 h-8 flex items-center justify-center bg-white/5 rounded-lg text-gray-400 hover:text-white hover:bg-white/10 shrink-0 border border-white/5 active:bg-blue-500 active:text-white transition-colors">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                    </div>
                `;
                list.appendChild(el);
            });
            new Sortable(list, { handle: '.drag-handle', ghostClass: 'opacity-50', onEnd: async function () { const ids = Array.from(list.children).map(c => c.getAttribute('data-id')); await saveOrder(ids); } });
        }
        async function saveOrder(ids) { await fetch('/api/products/reorder', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': adminToken }, body: JSON.stringify({ productIds: ids }) }); }

        // ...Helper functions...
        $('#add-product-btn').addEventListener('click', () => openProductModal(null));

        // R√©tablissement des boutons d'ajout (CRUCIAL POUR QUE √áA MARCHE)
        $('#modal-add-price').addEventListener('click', () => addPriceRow());
        $('#modal-add-variety').addEventListener('click', () => addVarietyRow());
        $('#modal-add-image').addEventListener('click', () => addImageRow());

        window.setDescPos = (pos) => {
            $('#modal-desc-pos').value = pos;
            $('#desc-pos-up').className = pos === 'top' ? 'flex-1 bg-[#ef4444] text-white py-3 rounded-lg text-xs font-bold' : 'flex-1 bg-white/5 py-3 rounded-lg text-xs text-gray-400 border border-white/5';
            $('#desc-pos-down').className = pos === 'bottom' ? 'flex-1 bg-[#ef4444] text-white py-3 rounded-lg text-xs font-bold' : 'flex-1 bg-white/5 py-3 rounded-lg text-xs text-gray-400 border border-white/5';
        };

        window.openProductModal = (id) => {
            const modal = $('#product-modal');
            $('#modal-prices-list').innerHTML = ''; $('#modal-varieties-list').innerHTML = ''; $('#modal-images-list').innerHTML = '';
            const catSelect = $('#modal-category'); catSelect.innerHTML = '';
            appSettings.categories.forEach(c => catSelect.innerHTML += `<option value="${c}">${c}</option>`);

            if (id) {
                const p = productsData[id];
                $('#product-id-input').value = id;
                $('#modal-name').value = p.name;
                $('#modal-category').value = p.category;
                $('#modal-farm').value = p.farm || '';
                $('#modal-description').value = p.description || '';
                $('#modal-extraInfo').value = p.extraInfo || '';
                $('#modal-extraInfoColor').value = p.extraInfoColor || '#ef4444';
                setDescPos(p.descPosition || 'top');
                $('#modal-title').innerText = "Modifier " + p.name;
                if (p.prices) Object.entries(p.prices).forEach(([w, pr]) => addPriceRow(w, pr));
                if (p.varieties) p.varieties.forEach(v => addVarietyRow(v, (p.mediaMap?.[v] || []).join(',')));
                if (p.images) p.images.forEach(url => addImageRow(url));
                $('#modal-delete-btn').classList.remove('hidden');
            } else {
                $('#product-id-input').value = `prod_${Date.now()}`;
                $('#modal-name').value = ''; $('#modal-description').value = ''; $('#modal-farm').value = ''; $('#modal-extraInfo').value = '';
                setDescPos('top');
                $('#modal-title').innerText = "Nouveau Produit";
                addPriceRow('1g', 10);
                $('#modal-delete-btn').classList.add('hidden');
            }
            modal.classList.remove('hidden');
        };

        function rgbToHex(col) { if (col.charAt(0) == '#') return col; var rgb = col.match(/\d+/g); return '#' + ((1 << 24) + (parseInt(rgb[0]) << 16) + (parseInt(rgb[1]) << 8) + parseInt(rgb[2])).toString(16).slice(1); }
        window.setBadgeColor = (color, btn) => {
            $('#modal-extraInfoColor').value = color;
            $$('.color-btn').forEach(b => { b.style.borderColor = 'transparent'; b.style.transform = 'scale(1)'; });
            if (btn) { btn.style.borderColor = 'white'; btn.style.transform = 'scale(1.1)'; }
        }
        window.closeProductModal = () => $('#product-modal').classList.add('hidden');

        $('#modal-save-btn').addEventListener('click', async () => {
            const id = $('#product-id-input').value;
            const p = {
                id, name: $('#modal-name').value || '---', category: $('#modal-category').value, farm: $('#modal-farm').value, description: $('#modal-description').value,
                descPosition: $('#modal-desc-pos').value, extraInfo: $('#modal-extraInfo').value, extraInfoColor: $('#modal-extraInfoColor').value,
                prices: {}, varieties: [], mediaMap: {}, images: []
            };
            $$('#modal-prices-list > div').forEach(r => {
                const inputs = r.querySelectorAll('input');
                if (inputs[0].value) p.prices[inputs[0].value] = parseFloat(inputs[1].value);
            });
            $$('#modal-varieties-list > div').forEach(r => {
                const inputs = r.querySelectorAll('input');
                const v = inputs[0].value; const m = inputs[1].value;
                if (v) { p.varieties.push(v); p.mediaMap[v] = m.split(',').filter(x => x); }
            });
            $$('#modal-images-list > div').forEach(r => {
                const inputs = r.querySelectorAll('input');
                if (inputs[0].value) p.images.push(inputs[0].value);
            });

            try { await fetch('/api/products', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': adminToken }, body: JSON.stringify(p) }); await loadProducts(); closeProductModal(); } catch (e) { alert("Erreur"); }
        });

        $('#modal-delete-btn').addEventListener('click', async () => { if (confirm("Supprimer?")) { await fetch(`/api/products/${$('#product-id-input').value}`, { method: 'DELETE', headers: { 'Authorization': adminToken } }); loadProducts(); closeProductModal(); } });

        function addPriceRow(w = '', p = '') {
            const div = document.createElement('div');
            // Stims mobile use: larger inputs
            div.innerHTML = `
                <div class="flex gap-2 mb-2 items-center">
                    <input class="w-1/2 input-dark rounded-lg px-3 py-2 text-base bg-black/30 border border-white/5" placeholder="Poids (1g)" value="${w}">
                    <input class="w-1/3 input-dark rounded-lg px-3 py-2 text-base bg-black/30 border border-white/5" placeholder="‚Ç¨" type="number" value="${p}">
                    <button type="button" class="text-red-500 w-10 flex items-center justify-center hover:bg-red-500/10 rounded-lg h-10" onclick="this.parentElement.parentElement.remove()"><i class="fas fa-trash-alt"></i></button>
                </div>`;
            $('#modal-prices-list').appendChild(div);
        }
        function addVarietyRow(v = '', m = '') {
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="flex flex-col gap-2 mb-3 bg-black/20 p-2 rounded-lg border border-white/5">
                     <div class="flex gap-2">
                        <input class="flex-1 input-dark rounded-lg px-3 py-2 text-base bg-black/30" value="${v}" placeholder="Nom Vari√©t√©">
                        <button type="button" class="text-red-500 w-10 flex items-center justify-center hover:bg-red-500/10 rounded-lg" onclick="this.parentElement.parentElement.remove()"><i class="fas fa-trash-alt"></i></button>
                     </div>
                     <div class="relative w-full">
                         <input class="w-full input-dark rounded-lg px-3 py-2 text-sm bg-black/30 pr-10" value="${m}" placeholder="Lien Image..." oninput="convertGithubLink(this)">
                         <label class="absolute right-0 top-0 h-full w-10 flex items-center justify-center cursor-pointer text-gray-400 hover:text-white">
                             <i class="fas fa-cloud-upload-alt"></i>
                             <input type="file" class="hidden" onchange="uploadAsset(this)">
                         </label>
                     </div>
                </div>`;
            $('#modal-varieties-list').appendChild(div);
        }
        function addImageRow(u = '') {
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="flex gap-2 mb-2 items-center">
                    <div class="relative flex-1">
                        <input class="w-full input-dark rounded-lg px-3 py-2 text-sm bg-black/30 pr-10" value="${u}" placeholder="URL..." oninput="convertGithubLink(this)">
                         <label class="absolute right-0 top-0 h-full w-10 flex items-center justify-center cursor-pointer text-gray-400 hover:text-white">
                             <input type="file" class="hidden" onchange="uploadAsset(this)">
                             <i class="fas fa-cloud-upload-alt"></i>
                         </label>
                    </div>
                     <button type="button" class="text-red-500 w-10 flex items-center justify-center hover:bg-red-500/10 rounded-lg" onclick="this.parentElement.remove()"><i class="fas fa-trash-alt"></i></button>
                </div>`;
            $('#modal-images-list').appendChild(div);
        }

        async function uploadAsset(input) {
            const file = input.files[0]; if (!file) return;
            const formData = new FormData(); formData.append('file', file);
            const container = input.closest('label').parentElement;
            const textInput = input.closest('label').previousElementSibling || input.closest('.relative').querySelector('input[type=text]');
            const icon = input.closest('label').querySelector('i');
            const oldClass = icon.className; icon.className = "fas fa-spinner fa-spin text-yellow-500";
            try {
                const res = await fetch('/api/upload-github', { method: 'POST', headers: { 'Authorization': adminToken }, body: formData });
                const data = await res.json();
                if (data.success) { textInput.value = data.url; icon.className = "fas fa-check text-green-500"; setTimeout(() => icon.className = oldClass, 2000); }
                else { alert(data.message); icon.className = "fas fa-times text-red-500"; }
            } catch (e) { alert("Erreur upload"); icon.className = "fas fa-times text-red-500"; }
        }

        async function loadGithubFiles() {
            const list = $('#github-files-list'); list.innerHTML = '<i class="fas fa-spinner fa-spin text-white"></i>';
            const res = await fetch('/api/github-files', { headers: { 'Authorization': adminToken } });
            const json = await res.json();
            list.innerHTML = '';
            (json.data || []).forEach(f => {
                const isImg = f.name.match(/\.(jpg|png|gif|webp)$/i);
                list.innerHTML += `<div class="aspect-square bg-white/5 rounded-lg overflow-hidden relative group">
                    ${isImg ? `<img src="${f.raw_url}" class="w-full h-full object-cover">` : '<div class="w-full h-full flex items-center justify-center"><i class="fas fa-file"></i></div>'}
                    <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center p-2 text-center transition-opacity">
                         <button onclick="copyToClipboard('${f.raw_url}')" class="bg-blue-500 text-white text-[10px] px-2 py-1 rounded mb-1 w-full">Copier</button>
                         <button onclick="deleteGithubFile('${f.path}','${f.sha}')" class="bg-red-500 text-white text-[10px] px-2 py-1 rounded w-full">Supprimer</button>
                    </div>
                </div>`;
            });
        }
        async function deleteGithubFile(p, s) { if (confirm("Supprimer ?")) await fetch('/api/github-delete', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': adminToken }, body: JSON.stringify({ path: p, sha: s }) }); loadGithubFiles(); }
        function copyToClipboard(t) { navigator.clipboard.writeText(t).then(() => alert("URL Copi√©e")); }
        function convertGithubLink(i) { if (i.value.includes('github.com') && i.value.includes('/blob/')) i.value = i.value.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/'); }
        function renderSettingsUI() {
            $('#app-title').value = appSettings.appTitle || ''; $('#banner-text').value = appSettings.bannerText || ''; $('#hero-image').value = appSettings.heroImage || '';
            const cl = $('#category-list-ui'); cl.innerHTML = '';
            (appSettings.categories || []).forEach(c => cl.innerHTML += `<div class="bg-white/5 p-3 rounded-lg flex justify-between mb-2"><span>${c}</span><div><button onclick="editCategory('${c}')" class="text-blue-400 mr-3"><i class="fas fa-edit"></i></button><button onclick="removeCategory('${c}')" class="text-red-500"><i class="fas fa-trash"></i></button></div></div>`);
        }
        $('#add-category-btn').addEventListener('click', async () => { const v = $('#new-category-input').value.toUpperCase(); if (v && !appSettings.categories.includes(v)) { appSettings.categories.push(v); await saveSettings(true); renderSettingsUI(); $('#new-category-input').value = ''; } });
        window.removeCategory = async (c) => { if (confirm("Supprimer?")) { appSettings.categories = appSettings.categories.filter(x => x !== c); await saveSettings(true); renderSettingsUI(); } };
        window.editCategory = async (c) => { const n = prompt("Nom:", c); if (n && n !== c) { appSettings.categories[appSettings.categories.indexOf(c)] = n.toUpperCase(); await saveSettings(true); renderSettingsUI(); } };
        window.openPreview = () => { $('#preview-iframe').src = 'index.html'; $('#preview-modal').classList.remove('hidden'); }
        window.closePreview = () => { $('#preview-modal').classList.add('hidden'); $('#preview-iframe').src = ''; }

        // --- LOYALTY REWARDS MANAGEMENT ---

        function renderRewardsList() {
            const list = document.getElementById('rewards-list');
            if (!list) return;

            list.innerHTML = '';

            // Ensure structure
            if (!appSettings.loyalty) appSettings.loyalty = {};
            if (!appSettings.loyalty.rewards) appSettings.loyalty.rewards = [];

            if (appSettings.loyalty.rewards.length === 0) {
                list.innerHTML = '<div class="text-gray-500 text-center py-4 text-xs italic">Aucune r√©compense configur√©e.</div>';
                return;
            }

            appSettings.loyalty.rewards.forEach((r, idx) => {
                const el = document.createElement('div');
                el.className = 'bg-white/5 p-3 rounded-lg border border-white/5 flex gap-2 items-center';
                // Input Text + Input Number + Delete
                el.innerHTML = `
                    <div class="flex-1">
                        <input type="text" 
                            class="w-full bg-transparent border-none text-white text-sm focus:ring-0 placeholder-gray-600 font-bold" 
                            placeholder="Nom du cadeau..."
                            value="${r.description || ''}"
                            onchange="updateReward(${idx}, 'description', this.value)"
                        >
                    </div>
                    <div class="w-20 border-l border-white/10 pl-2">
                        <input type="number" 
                            class="w-full bg-transparent border-none text-amber-500 text-sm focus:ring-0 font-mono text-center font-bold" 
                            placeholder="Pts"
                            value="${r.threshold || 10}"
                            min="1" max="100"
                            onchange="updateReward(${idx}, 'threshold', parseInt(this.value))"
                            title="Points requis"
                        >
                    </div>
                    <button onclick="deleteReward(${idx})" class="text-red-500 hover:text-red-400 p-2">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                list.appendChild(el);
            });
        }

        window.addReward = () => {
            if (!appSettings.loyalty) appSettings.loyalty = {};
            if (!appSettings.loyalty.rewards) appSettings.loyalty.rewards = [];

            if (appSettings.loyalty.rewards.length >= 10) {
                alert("Maximum 10 r√©compenses atteint.");
                return;
            }

            appSettings.loyalty.rewards.push({ description: "", threshold: 10 });
            renderRewardsList();
        };

        window.deleteReward = (idx) => {
            if (!confirm("Supprimer cette r√©compense ?")) return;
            appSettings.loyalty.rewards.splice(idx, 1);
            renderRewardsList();
        };

        window.updateReward = (idx, field, value) => {
            if (appSettings.loyalty.rewards[idx]) {
                appSettings.loyalty.rewards[idx][field] = value;
            }
        };

        window.saveLoyaltySettings = async () => {
            try {
                // Clean empty rewards
                if (appSettings.loyalty && appSettings.loyalty.rewards) {
                    appSettings.loyalty.rewards = appSettings.loyalty.rewards.filter(r => r.description && r.description.trim() !== "");
                }

                await saveSettings(true); // Save global appSettings
                alert("Configuration fid√©lit√© sauvegard√©e !");
                renderRewardsList(); // Re-render to show clean state
            } catch (e) {
                alert("Erreur lors de la sauvegarde.");
                console.error(e);
            }
        };

        // Hook into existing renderSettingsUI to init rewards
        const originalRenderSettings = renderSettingsUI;
        renderSettingsUI = function () {
            originalRenderSettings();
            renderRewardsList();
        };

    </script>
</body>

</html>