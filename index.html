<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Full Terps Exotica</title>

    <meta property="og:url" content="https://t.me/jefecalidelivery5" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- PRELOAD LOGO (Affichage instantan√©) -->
    <link rel="preload" as="image" href="uploads/logo_splashscreen.jpg">

    <meta property="og:image" content="uploads/logo_splashscreen.jpg" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>


    <style>
        :root {
            --bg-dark: #050505;
            --glass-bg: rgba(30, 30, 35, 0.30);
            --glass-border: rgba(255, 255, 255, 0.12);
            --accent-primary: #ffffff;
            --accent-secondary: #a1a1aa;
            --highlight: #ef4444;
            --radius-bento: 24px;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-dark);
            color: #ffffff;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            /* Prevents pull-to-refresh */
            touch-action: pan-y;
            /* Improves scroll handling */
            user-select: none;
            /* Prevents text selection like an app */
        }

        #app-container {
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            position: relative;
            background: transparent;
            padding-bottom: 100px;
        }

        @media (min-width: 768px) {

            #app-container,
            .full-page-overlay,
            .mobile-fixed {
                max-width: 640px !important;
            }
        }

        /* CONFIGURATION DU FOND ANIM√â */
        .fond-anime {
            background: linear-gradient(-45deg, #4a0404, #033311, #4a0404, #033311);
            background-size: 400% 400%;
            animation: gradientAnimation 15s ease infinite;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
        }

        @keyframes gradientAnimation {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }



        /* Bento Card */
        .bento-card {
            background: rgba(30, 30, 35, 0.4);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-bento);
            overflow: hidden;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            transition: transform 0.2s cubic-bezier(0.25, 0.8, 0.25, 1), box-shadow 0.2s ease;
        }

        .bento-card:active {
            transform: scale(0.98);
            box-shadow: 0 4px 10px 0 rgba(0, 0, 0, 0.2);
        }

        .bento-card.hero-card {
            background: rgba(255, 255, 255, 0.02);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            /* MODIFICATION: Suppression du padding-top pour combler le vide */
            /* padding-top: 1rem; */
        }

        .bento-card.glass-transparent-red {
            background: rgba(239, 68, 68, 0.05);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            border: 1px solid rgba(239, 68, 68, 0.2);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.1);
        }

        /* MODIFICATION: Image en cover sans padding pour prendre toute la place */
        #header-carousel-track img {
            object-fit: cover;
            padding: 0;
            width: 100%;
            height: 100%;
            object-position: center 20%;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Nav Dock */
        .nav-dock {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 420px;
            background: rgba(20, 20, 22, 0.4);
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border-radius: 100px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 12px 20px;
            z-index: 50;
        }

        .nav-item {
            color: var(--accent-secondary);
            font-size: 1.2rem;
            transition: all 0.3s ease;
            position: relative;
            padding: 8px;
        }

        .nav-item.active {
            color: var(--accent-primary);
            transform: translateY(-2px);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 4px;
            background: var(--accent-primary);
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
        }

        /* Category Pills - Bento Style */
        .category-scroll {
            display: flex;
            gap: 8px;
            /* Reduced gap for tighter bento feel */
            overflow-x: auto;
            padding: 4px 16px;
            /* Horizontal padding ensures first/last items aren't cut off */
            justify-content: flex-start;
            /* Removed mask-image to prevent cutting off edges */
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
            scroll-snap-type: x mandatory;
            touch-action: pan-x;
            cursor: grab;
        }

        .category-scroll:active {
            cursor: grabbing;
        }

        .cat-pill {
            /* Bento Grid Style Pill */
            /* 3 items per view (approx 1/3 width minus gap adjustment) */
            flex: 0 0 calc(33.333% - 6px);
            max-width: calc(33.333% - 6px);
            scroll-snap-align: start;
            /* Ensure at least 4 fit */

            background: rgba(25, 25, 30, 0.6);
            /* Darker bento background */
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 9999px;
            /* Fully rounded pills */
            padding: 10px 16px;

            font-size: 0.75rem;
            font-weight: 600;
            color: #d4d4d8;
            /* Light gray text */

            white-space: nowrap;
            text-align: center;

            transition: all 0.2s ease-out;
            text-transform: uppercase;
            letter-spacing: 0.02em;
            backdrop-filter: blur(12px);

            scroll-snap-align: center;
            /* Snap to center ensures it's fully in view */

            opacity: 0;
            animation: slideInRight 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .cat-pill.active {
            background: var(--accent-primary);
            color: #000;
            /* Black text on active */
            border-color: var(--accent-primary);
            font-weight: 800;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
            /* Pop effect */
            z-index: 2;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .cat-pill.active {
            background: var(--accent-primary);
            color: #000;
            border-color: var(--accent-primary);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
            backdrop-filter: none;
        }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, rgba(23, 91, 28, 0.85) 0%, rgba(79, 13, 13, 0.85) 100%);
            /* D√©grad√© vert (#175b1c) et rouge (#4f0d0d) avec transparence */
            backdrop-filter: blur(50px);
            /* L'effet de flou (Blur) */
            -webkit-backdrop-filter: blur(50px);
            /* Pour la compatibilit√© Safari */
            transition: background 2s ease-in-out, backdrop-filter 2s ease-in-out, -webkit-backdrop-filter 2s ease-in-out, opacity 0.8s ease;
        }

        .splash-logo {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 0 60px rgba(255, 255, 255, 0.15);
            animation: breathe 3s infinite ease-in-out;
            border: 2px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        @keyframes breathe {

            0%,
            100% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.05);
                filter: brightness(1.2);
            }
        }

        /* Marquee */
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            position: relative;
        }

        .marquee-track {
            display: flex;
            width: fit-content;
            animation: marquee 20s linear infinite;
        }

        @keyframes marquee {
            0% {
                transform: translateX(0);
            }

            100% {
                transform: translateX(-25%);
            }
        }

        /* Full Page Overlays */
        .full-page-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            margin: 0 auto;
            width: 100%;
            max-width: 480px;
            height: 100%;
            background: #000;
            z-index: 60;
            /* overflow-y: auto; REMOVED - Managed by inner container */
            overflow: hidden;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            will-change: transform;
            backface-visibility: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            display: flex;
            flex-direction: column;
        }

        .full-page-overlay.active {
            transform: translateY(0);
        }

        .scroll-content {
            flex: 1;
            overflow-y: auto;
            width: 100%;
            position: relative;
            /* Ensure last element is visible above the sticky footer (approx 100px + safe area) */
            padding-bottom: calc(120px + env(safe-area-inset-bottom, 20px));
        }

        .safe-area-pb {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        .mobile-fixed {
            position: fixed;
            left: 0;
            right: 0;
            margin: 0 auto;
            max-width: 480px;
            width: 100%;
        }

        /* Sticky footer for flex container */
        .sticky-footer-flex {
            flex-shrink: 0;
            position: relative;
            z-index: 50;
            background: #111;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Elements */
        .ripple-effect {
            position: relative;
            overflow: hidden;
        }

        .ripple-span {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s linear;
            background-color: rgba(255, 255, 255, 0.3);
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        .btn-primary {
            background: var(--accent-primary);
            color: #000;
            font-weight: 700;
            border-radius: 14px;
            padding: 14px;
            width: 100%;
            text-align: center;
            border: none;
            transition: 0.2s;
        }

        .btn-primary:active {
            transform: scale(0.96);
        }

        .btn-glass {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 14px;
            padding: 12px;
            font-weight: 600;
            text-align: center;
        }

        .btn-glass:active,
        .option-btn:active,
        .shipping-btn:active,
        .carrier-btn:active,
        .payment-btn:active {
            transform: scale(0.96);
            opacity: 0.8;
            transition: transform 0.1s;
        }

        .option-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .option-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 4px;
            text-align: center;
            color: #ccc;
            transition: 0.2s;
        }

        .option-btn.active {
            background: var(--accent-primary);
            color: #000;
            border-color: var(--accent-primary);
            font-weight: bold;
        }

        /* PRODUCT SHEET ANIMATION & STYLE */
        #product-content-sheet {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            will-change: transform;
            height: 70vh;
            bottom: 0;
            position: absolute;
            width: 100%;
            /* Glassmorphism Active State */
            background-color: rgba(10, 10, 12, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            backface-visibility: hidden;
            -webkit-backface-visibility: hidden;
            transform-style: preserve-3d;
            z-index: 20;
        }

        #product-content-sheet.collapsed {
            transform: translateY(calc(100% - 160px));
            /* Glassmorphism Collapsed State (Slightly more transparent) */
            background-color: rgba(18, 18, 23, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        #sheet-handle-area,
        #cart-handle-area,
        #info-handle-area {
            cursor: grab;
            touch-action: none;
        }

        #sheet-handle-area:active,
        #cart-handle-area:active {
            cursor: grabbing;
        }

        .sheet-handle {
            transition: background-color 0.3s;
        }

        #product-content-sheet.collapsed .sheet-handle {
            background-color: var(--accent-primary);
        }

        #admin-panel-overlay {
            background: rgba(0, 0, 0, 0.95);
            font-family: 'Courier New', monospace;
            color: #0f0;
            display: none;
        }

        .input-error {
            border-color: #ef4444 !important;
            animation: shake 0.5s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        /* NEW: Glass Pill Button */
        .btn-glass-pill {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            padding: 0;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .btn-glass-pill:active {
            transform: scale(0.94);
            background: rgba(255, 255, 255, 0.25);
        }

        /* NEW: Glass Badge (Text Pill) */
        .glass-badge {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            color: white;
            padding: 6px 16px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* NEW: Fullscreen Overlay */
        #fullscreen-media-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 200;
            background: #000;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #fullscreen-media-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .fullscreen-slide {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            scroll-snap-align: center;
            position: relative;
        }

        .fullscreen-slide img,
        .fullscreen-slide video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .contact-card-custom {
            background: rgba(21, 11, 11, 0.45) !important;
            -webkit-backdrop-filter: blur(13px) !important;
            backdrop-filter: blur(13px) !important;
            border: 1px solid rgba(21, 11, 11, 0.225) !important;
        }
    </style>
</head>

<body>

    <!-- STRUCTURE HTML DU FOND -->
    <!-- FOND ANIM√â -->
    <!-- FOND ANIM√â -->
    <div class="fond-anime"></div>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="relative z-10 flex flex-col items-center">
            <!-- Logo g√©r√© dynamiquement par le script, mais pr√©-rempli pour affichage imm√©diat -->
            <img id="splash-logo" class="splash-logo mb-6" src="uploads/logo_splashscreen.jpg" alt="Splash Logo">

            <div
                class="w-48 h-1.5 bg-white/10 rounded-full overflow-hidden backdrop-blur-md border border-white/20 shadow-[0_0_15px_rgba(255,255,255,0.1)]">
                <div id="loading-bar-progress"
                    class="h-full bg-white/80 shadow-[0_0_10px_rgba(255,255,255,0.5)] transition-all duration-[1500ms] w-0">
                </div>
            </div>
        </div>
    </div>

    <div id="app-container">
        <div class="p-4 grid grid-cols-2 gap-3 pt-6">
            <div class="bento-card hero-card col-span-2 h-auto relative group" id="banner-container"
                style="overflow: hidden; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.01) 100%);">
                <img src="uploads/banner_home.jpg" alt="Full Terps Exotica Banner"
                    style="width: 100%; height: auto; object-fit: contain; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));">
            </div>

            <div class="bento-card glass-transparent-red col-span-2 py-3 px-4 flex items-center">
                <div class="text-red-400 mr-3"><i class="fas fa-bullhorn"></i></div>
                <div id="promo-banner" class="marquee-container flex-1 overflow-hidden">
                    <div class="marquee-track text-sm font-medium text-red-200">
                        <div class="marquee-group flex shrink-0 gap-8 pr-8"><span>Bienvenue chez Full Terps Exotica !
                                Livraison
                                express
                                üöÄ 11h-23h üïò 7J/7üü¢</span></div>
                        <div class="marquee-group flex shrink-0 gap-8 pr-8"><span>Bienvenue chez Full Terps Exotica !
                                Livraison
                                express
                                üöÄ 11h-23h üïò 7J/7üü¢</span></div>
                        <div class="marquee-group flex shrink-0 gap-8 pr-8"><span>Bienvenue chez Full Terps Exotica !
                                Livraison
                                express
                                üöÄ 11h-23h üïò 7J/7üü¢</span></div>
                        <div class="marquee-group flex shrink-0 gap-8 pr-8"><span>Bienvenue chez Full Terps Exotica !
                                Livraison
                                express
                                üöÄ 11h-23h üïò 7J/7üü¢</span></div>
                    </div>
                </div>
            </div>

            <div class="col-span-2 mt-2">
                <div class="category-scroll hide-scrollbar" id="category-scroll-container">
                    <!-- Categories loaded dynamically -->
                </div>
            </div>
        </div>
        <div id="product-grid" class="px-4 pb-24 grid grid-cols-2 gap-3"></div>
    </div>

    <nav class="nav-dock">
        <a href="javascript:void(0)" onclick="window.showHome()" class="nav-item active ripple-effect"><i
                class="fas fa-home"></i></a>
        <a href="javascript:void(0)" onclick="window.openContactModal()" class="nav-item ripple-effect"><i
                class="fas fa-comment-dots"></i></a>
        <a href="javascript:void(0)" onclick="window.openCartPage()" class="nav-item ripple-effect relative">
            <i class="fas fa-shopping-bag"></i>
            <span id="cart-badge" class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full hidden"></span>
        </a>
    </nav>

    <div id="product-page" class="full-page-overlay bg-black overflow-hidden">
        <button onclick="window.hideProduct()"
            class="absolute top-4 left-4 z-50 btn-glass-pill ripple-effect active:scale-90 transition-transform">
            <i class="fas fa-chevron-down"></i>
        </button>
        <span id="product-category" class="absolute top-4 right-4 z-40 glass-badge">WEED</span>

        <button onclick="openFullscreenMedia()" class="absolute top-16 right-4 z-40 btn-glass-pill ripple-effect">
            <i class="fas fa-expand"></i>
        </button>

        <div class="absolute inset-0 w-full h-full bg-black z-0 pt-20">
            <div id="carousel-track" class="w-full h-full flex transition-transform duration-300"></div>
            <div class="absolute inset-0 flex items-center justify-between px-2 pointer-events-none z-10 pt-20">
                <button onclick="window.prevSlide()"
                    class="pointer-events-auto w-10 h-10 bg-black/20 rounded-full text-white/70 backdrop-blur flex items-center justify-center hover:bg-black/50 transition"><i
                        class="fas fa-chevron-left"></i></button>
                <button onclick="window.nextSlide()"
                    class="pointer-events-auto w-10 h-10 bg-black/20 rounded-full text-white/70 backdrop-blur flex items-center justify-center hover:bg-black/50 transition"><i
                        class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="product-content-sheet" class="z-20 flex flex-col">
            <div id="sheet-handle-area" class="w-full pt-4 pb-4 z-30 flex justify-center cursor-pointer shrink-0">
                <div class="sheet-handle w-12 h-1.5 bg-gray-600 rounded-full"></div>
            </div>
            <div class="px-6 pb-48 overflow-y-auto flex-1">
                <div class="flex justify-between items-start mb-2 pointer-events-none">
                    <h2 id="product-name" class="text-3xl font-bold leading-tight text-white flex-1 mr-4">Product Name
                    </h2>
                    <div class="text-xs text-white/80 font-mono uppercase tracking-wide cursor-pointer pointer-events-auto bg-white/10 border border-white/10 px-3 py-1.5 rounded-full backdrop-blur-sm hover:bg-white/20 transition-colors flex items-center gap-2"
                        onclick="toggleSheet()"><i class="fas fa-eye"></i> Voir</div>
                </div>
                <p id="product-farm-container" class="text-gray-400 text-sm mb-6 flex items-center gap-2 hidden">
                    <span id="product-farm">Farm Name</span>
                </p>
                <p id="product-description"
                    class="text-gray-300 text-sm mb-6 leading-relaxed hidden whitespace-pre-line"></p>
                <div id="product-options" class="space-y-6 mb-6"></div>
                <!-- Text Section Removed -->
            </div>
        </div>

        <div class="mobile-fixed bottom-0 bg-[#0a0a0a] border-t border-white/10 p-4 safe-area-pb z-50 flex gap-3">
            <button id="add-to-cart-btn"
                class="flex-1 btn-glass ripple-effect text-sm font-semibold flex items-center justify-center gap-2">
                <i class="fas fa-cart-plus"></i> Panier
            </button>
            <button id="buy-now-btn"
                class="flex-[2] btn-primary ripple-effect flex items-center justify-center gap-2 text-sm shadow-lg shadow-white/10">
                <i class="fab fa-telegram-plane"></i> COMMANDER
            </button>
        </div>
    </div>

    <div id="cart-page" class="full-page-overlay bg-[#050505]">
        <!-- Header / Handle -->
        <!-- Header / Handle (Exact Copy of Product Sheet) -->
        <div id="cart-handle-area" style="touch-action: none;"
            class="w-full py-6 z-[9999] flex justify-center cursor-pointer shrink-0">
            <div class="sheet-handle w-12 h-1.5 bg-gray-600 rounded-full pointer-events-none"></div>
        </div>

        <!-- Scrollable Content -->
        <div class="scroll-content pb-24">
            <div class="p-4 pb-0">
                <h2 class="text-xl font-bold mb-2">Mon Panier</h2>
            </div>
            <div id="cart-items-page" class="p-4 space-y-3 min-h-[200px]"></div>
            <div id="checkout-options-container" class="px-4 space-y-4 mt-4 mb-24 hidden">
                <div class="bento-card p-4">
                    <h3 class="text-sm text-gray-400 mb-3 uppercase tracking-wider font-bold">Livraison</h3>
                    <div id="shipping-options-container" class="flex gap-2"></div>
                </div>

                <div id="delivery-carrier-container" class="bento-card p-4 hidden">
                    <h3 class="text-sm text-gray-400 mb-3 uppercase tracking-wider font-bold">Option de livraison</h3>
                    <div id="carrier-options-container" class="gap-2 mb-3 hidden"></div>
                    <button id="btn-open-info" onclick="window.openInfoPage()"
                        class="w-full py-3 bg-blue-600/20 border border-blue-500/50 text-blue-400 rounded-xl text-sm font-bold flex items-center justify-center gap-2 ripple-effect">
                        <i class="fas fa-edit"></i> Remplir mes informations <span id="info-status-icon"></span>
                    </button>
                </div>

                <div id="payment-section-card" class="bento-card p-4 hidden">
                    <h3 class="text-sm text-gray-400 mb-3 uppercase tracking-wider font-bold">Paiement</h3>
                    <div class="grid grid-cols-2 gap-2" id="payment-methods-container">
                        <div class="text-gray-500 text-sm italic w-full text-center py-2">S√©lectionnez une livraison
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Sticky Footer -->
        <div class="sticky-footer-flex p-4 safe-area-pb">
            <div class="flex justify-between items-center mb-3">
                <span class="text-gray-400">Total estim√©</span>
                <span id="cart-total-page" class="text-2xl font-bold text-white">0‚Ç¨</span>
            </div>
            <button onclick="window.placeOrder()" class="btn-primary ripple-effect">VALIDER LA COMMANDE</button>
        </div>
    </div>

    <div id="message-modal"
        class="fixed top-6 left-1/2 transform -translate-x-1/2 z-[100] opacity-0 pointer-events-none transition-all duration-300 w-auto max-w-[90%]">
    </div>

    <div id="contact-modal-overlay" onclick="window.closeContactModal()"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[90] flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 p-4">
        <div onclick="event.stopPropagation()"
            class="bento-card contact-card-custom w-full max-w-sm p-5 transform scale-90 transition-transform duration-300 relative">
            <button
                class="absolute top-2 right-2 text-gray-400 hover:text-white cursor-pointer p-2 rounded-full hover:bg-white/10 transition"
                onclick="window.closeContactModal()"><i class="fas fa-times text-lg"></i></button>
            <div class="text-center mb-4">
                <!-- Logo Contact li√© au script -->
                <img id="contact-logo-img" src="uploads/logo_splashscreen.jpg"
                    class="w-14 h-14 rounded-2xl mx-auto mb-2 object-cover shadow-lg"
                    onerror="this.src='https://placehold.co/100/333/fff?text=BC'">
                <h3 class="text-lg font-bold">Full Terps Exotica</h3>
                <p class="text-gray-400 text-xs">Support 7j/7 - R√©ponse rapide</p>
            </div>
            <div class="space-y-2">
                <!-- Telegram PV -->
                <a id="btn-tg-pv" href="javascript:void(0)"
                    onclick="window.openExternalLink('https://t.me/FullTerpzExotica')"
                    class="block bg-[#0088cc]/20 border border-[#0088cc]/30 p-3 rounded-xl flex items-center gap-3 ripple-effect cursor-pointer">
                    <i class="fab fa-telegram text-2xl text-[#0088cc]"></i>
                    <div>
                        <div class="font-bold text-sm text-white">Telegram</div>
                        <div class="text-[10px] text-[#0088cc]">Discussion priv√©e</div>
                    </div>
                </a>

                <!-- Potato (Canal Principal) -->
                <!-- FULLTERPZEXO34 Link -->
                <a id="btn-potato" href="javascript:void(0)"
                    onclick="window.openExternalLink('https://duanym138.org/FULLTERPZEXO34')"
                    class="block bg-[#3d4d63] border border-white/10 p-3 rounded-xl flex items-center gap-3 ripple-effect cursor-pointer">
                    <img src="https://wab.potato.im/resources/images/logo1024.png"
                        class="w-8 h-8 object-contain rounded-full">
                    <div>
                        <div class="font-bold text-sm text-white">Canal Principal</div>
                        <div class="text-[10px] text-gray-300">Suivez-nous</div>
                    </div>
                </a>


                <!-- Instagram -->
                <a id="btn-insta" href="javascript:void(0)"
                    onclick="window.openExternalLink('https://www.instagram.com/fullterpz.exotica34?igsh=MTljeHpscWt1OXNwZg==')"
                    class="block bg-[#E1306C]/20 border border-[#E1306C]/30 p-3 rounded-xl flex items-center gap-3 ripple-effect cursor-pointer">
                    <i class="fab fa-instagram text-2xl text-[#E1306C]"></i>
                    <div>
                        <div class="font-bold text-sm text-white">Instagram</div>
                        <div class="text-[10px] text-[#E1306C]">Discussion priv√©e</div>
                    </div>
                </a>

                <!-- Signal -->
                <a id="btn-signal" href="javascript:void(0)"
                    onclick="window.openExternalLink('https://signal.me/#eu/-6kly6kKqR7FC8ofwXuTVQWjqlrBm384IVE9XK-t3JwDtPipfHBNXJDiscIOB9vB')"
                    class="block bg-[#3a76f0]/20 border border-[#3a76f0]/30 p-3 rounded-xl flex items-center gap-3 ripple-effect cursor-pointer">
                    <img src="https://static.vecteezy.com/system/resources/previews/067/565/467/non_2x/signal-rounded-logo-design-free-png.png"
                        class="w-8 h-8 object-contain">
                    <div>
                        <div class="font-bold text-sm text-white">Signal</div>
                        <div class="text-[10px] text-[#3a76f0]">Contact S√©curis√©</div>
                    </div>
                </a>

            </div>
        </div>
    </div>

    <div id="admin-panel-container"></div>

    <div id="fullscreen-media-overlay">
        <button onclick="closeFullscreenMedia()"
            class="absolute top-6 left-6 z-50 w-12 h-12 bg-black/30 backdrop-blur-md rounded-full text-white flex items-center justify-center border border-white/10 ripple-effect shadow-xl">
            <i class="fas fa-arrow-left text-lg"></i>
        </button>
        <div id="fullscreen-carousel-track"
            class="w-full h-full flex overflow-x-auto snap-x snap-mandatory hide-scrollbar">
            <!-- Dynamic Content -->
        </div>
    </div>

    <div id="info-page"
        class="fixed inset-x-0 bottom-0 z-[120] h-[90vh] bg-[#0c0c0c] rounded-t-[30px] border-t border-white/20 shadow-[0_-10px_40px_rgba(0,0,0,0.8)] transform translate-y-full transition-transform duration-500 ease-out flex flex-col will-change-transform backface-hidden"
        style="will-change: transform; backface-visibility: hidden;">
        <!-- Handle (Exact Copy of Product Sheet) -->
        <div id="info-handle-area" style="touch-action: none;"
            class="w-full py-6 z-[9999] flex justify-center cursor-pointer shrink-0">
            <div class="sheet-handle w-12 h-1.5 bg-gray-600 rounded-full pointer-events-none"></div>
        </div>
        <div class="p-4 pb-0 shrink-0">
            <h2 class="text-xl font-bold mb-2">Vos Coordonn√©es</h2>
            <p class="text-xs text-gray-400 mb-6">N√©cessaire pour le suivi de votre commande</p>
        </div>

        <div class="px-4 space-y-4 pb-32 overflow-y-auto flex-1">
            <div class="space-y-3">
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1 mb-1 block">@ Pseudo</label>
                    <input type="text" id="input-pseudo" placeholder="Votre pseudo"
                        class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-600 focus:border-white/30 outline-none transition-all">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold ml-1 mb-1 block">Nom</label>
                        <input type="text" id="input-nom" placeholder="Votre Nom"
                            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-600 focus:border-white/30 outline-none transition-all">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold ml-1 mb-1 block">Pr√©nom</label>
                        <input type="text" id="input-prenom" placeholder="Votre Pr√©nom"
                            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-600 focus:border-white/30 outline-none transition-all">
                    </div>
                </div>

                <div id="address-field-container">
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1 mb-1 block">üè° Adresse</label>
                    <textarea id="input-adresse" rows="2" placeholder="Num√©ro et Rue..."
                        class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-600 focus:border-white/30 outline-none transition-all resize-none"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold ml-1 mb-1 block">üåÜ
                            Ville</label>
                        <input type="text" id="input-ville" placeholder="Paris, Lyon..."
                            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-600 focus:border-white/30 outline-none transition-all">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase font-bold ml-1 mb-1 block">üî¢ Code
                            Postal</label>
                        <input type="text" id="input-zip" placeholder="75001"
                            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-600 focus:border-white/30 outline-none transition-all">
                    </div>
                </div>

                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1 mb-1 block">üü© Num√©ro
                        WhatsApp</label>
                    <input type="tel" id="input-whatsapp" placeholder="06 12 34 56 78"
                        class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-600 focus:border-white/30 outline-none transition-all">
                </div>

                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold ml-1 mb-1 block">üì© Adresse
                        Mail</label>
                    <input type="email" id="input-email" placeholder="contact@exemple.com"
                        class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-white placeholder-gray-600 focus:border-white/30 outline-none transition-all">
                </div>
            </div>

            <div class="bento-card p-4 bg-white/5 border border-red-500/20">
                <div class="flex items-start gap-3">
                    <i class="fas fa-shield-alt text-red-400 mt-1"></i>
                    <p class="text-xs text-gray-400 leading-relaxed">
                        Vos donn√©es sont chiffr√©es et supprim√©es automatiquement apr√®s livraison. Minimum 3
                        caract√®res par champ requis.
                    </p>
                </div>
            </div>
        </div>

        <div class="mobile-fixed bottom-0 bg-[#0c0c0c] border-t border-white/10 p-4 safe-area-pb z-50 shrink-0">
            <button onclick="window.saveUserInfo()"
                class="btn-primary ripple-effect w-full flex items-center justify-center gap-2">
                <i class="fas fa-save"></i> VALIDER MES INFOS
            </button>
        </div>
    </div>


    <!-- CONTACT MODAL -->
    <div id="contact-modal-overlay"
        class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-end justify-center hidden opacity-0 transition-opacity duration-300"
        onclick="if(event.target === this) window.closeContactModal()">
        <div id="contact-sheet"
            class="w-full max-w-md bg-gradient-to-br from-gray-900 to-black border-t-2 border-blue-500/50 rounded-t-3xl p-6 transform translate-y-full transition-transform duration-500 shadow-2xl shadow-blue-500/20"
            onclick="event.stopPropagation()">

            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                        <img id="contact-logo" class="w-14 h-14 rounded-full" alt="Contact">
                    </div>
                    <div>
                        <h3 id="contact-title" class="text-xl font-bold text-white">Contact</h3>
                        <p id="contact-subtitle" class="text-xs text-gray-400">Support rapide</p>
                    </div>
                </div>
                <button onclick="window.closeContactModal()"
                    class="w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition">
                    <i class="fas fa-times text-white text-lg"></i>
                </button>
            </div>

            <!-- Contact Buttons -->
            <div id="contact-buttons-container" class="space-y-3">
                <!-- Dynamically populated -->
            </div>
        </div>
    </div>

    <!-- banner_3d.js removed -->
    <script>
        // Existing Script Logic...
        // --- FONCTION UTILITAIRE POUR CONVERTIR LES LIENS GITHUB ---
        function getRawUrl(url) {
            // Transforme un lien 'blob' GitHub en lien 'raw' utilisable pour les images
            if (url && url.includes('github.com') && url.includes('/blob/')) {
                return url.replace('github.com', 'raw.githubusercontent.com').replace('/blob/', '/');
            }
            // Retourne l'URL telle quelle si ce n'est pas un blob ou si c'est d√©j√† un raw
            return url;
        }

        // --- CONFIGURATION LOGO ---
        // Mise √† jour avec le nouveau lien direct mms.jpg
        // Mise √† jour avec le nouveau lien direct
        let rawLogoUrl = "uploads/logo_splashscreen.jpg"; // Local fallback
        const APP_LOGO = rawLogoUrl;

        // --- CONFIGURATION DYNAMIQUE (Backend) ---
        let heroImages = [APP_LOGO]; // Default
        let orderUrl = ""; // Default
        let products = {}; // Sera rempli par l'API
        let appSettings = {};
        let cartItems = JSON.parse(localStorage.getItem('cartItems')) || {};


        let currentFilter = null;
        let currentProduct = null;
        let selectedVariety = null;
        let selectedWeight = null;
        let selectedShipping = null;
        let selectedPayment = null;
        let selectedCarrier = null;
        let selectedCarrierCost = 0;
        let userInfo = null;
        let isSheetCollapsed = false;
        let slideToVarietyMap = [];

        const productGrid = document.getElementById('product-grid');
        const productPage = document.getElementById('product-page');
        const productSheet = document.getElementById('product-content-sheet');
        const cartPage = document.getElementById('cart-page');
        const infoPage = document.getElementById('info-page');
        const modalMessage = document.getElementById('message-modal');
        const carouselTrack = document.getElementById('carousel-track');

        document.addEventListener('DOMContentLoaded', async () => {
            if (window.location.protocol === 'file:') {
                document.body.innerHTML = '<div style="background:black;color:red;height:100vh;display:flex;align-items:center;justify-content:center;text-align:center;font-size:24px;padding:20px;"><h1>ERREUR : SITE LANC√â INCORRECTEMENT</h1><p>Vous avez ouvert le fichier directement.</p><p>Pour que la base de donn√©es fonctionne, vous devez lancer le serveur (start_local.bat) et aller sur :<br><br><a href="http://localhost:3000" style="color:white;text-decoration:underline;">http://localhost:3000</a></p></div>';
                return;
            }

            // Telegram Mini App Setup
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = window.Telegram.WebApp;
                tg.ready();
                tg.expand();
                tg.enableClosingConfirmation();

                // Matches app dark theme
                if (tg.setHeaderColor) tg.setHeaderColor('#050505');
                if (tg.setBackgroundColor) tg.setBackgroundColor('#050505');

                // Set user info if available
                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    const user = tg.initDataUnsafe.user;
                    userInfo = userInfo || {};
                    // Pre-fill or use these if needed. 
                    // We largely rely on manual input but can use username
                    if (user.username && !document.getElementById('input-pseudo').value) {
                        document.getElementById('input-pseudo').value = '@' + user.username;
                    }
                }
            }

            // initStarfield('starfield-bg'); // Removed for new CSS bg


            // Chargement des donn√©es backend
            await loadBackendData();

            initSplash();
            initProductGrid();
            // initHeaderCarousel(); // Removed for 3D Banner
            initSheetGestures();
            initCartGestures(); // FIX: Added initialization call
            initInfoPageGestures(); // FIX: Ensure this is also called if not already

            updateCartCount();
            initCarouselGestures();

            // Dynamic Logo update
            const splashImg = document.getElementById('splash-logo');
            const contactImg = document.getElementById('contact-logo-img');

            if (splashImg) splashImg.src = APP_LOGO;
            if (contactImg) contactImg.src = APP_LOGO;

            // --- GLOBAL CART EVENT DELEGATION (Robustness Fix) ---
            const cartItemsContainer = document.getElementById('cart-items-page');
            if (cartItemsContainer) {
                cartItemsContainer.addEventListener('click', (e) => {
                    const btn = e.target.closest('.cart-action-btn');
                    if (!btn) return;

                    e.stopPropagation(); // Stop bubble
                    const action = btn.dataset.action;
                    const encodedId = btn.dataset.id;
                    if (!action || !encodedId) return;

                    const id = decodeURIComponent(encodedId);

                    if (action === 'remove') {
                        window.removeItem(id);
                    } else if (action === 'decrease') {
                        window.updateQty(id, -1);
                    } else if (action === 'increase') {
                        window.updateQty(id, 1);
                    }
                });
            }

            // --- GLOBAL DOCUMENT DELEGATION (Ultimate Fallback + Mobile Fix) ---
            // --- GLOBAL DOCUMENT DELEGATION (Ultimate Fallback + Mobile Fix + Telegram Safe + ID Based) ---
            let lastActionTime = 0;
            const handleCartAction = (e) => {
                const btn = e.target.closest('.cart-btn');
                if (!btn) return;

                // Safety: Ignore click if touch triggered recently (Ghost Click in WebView)
                if (e.type === 'click' && Date.now() - lastActionTime < 1000) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }

                if (e.type === 'touchend') {
                    lastActionTime = Date.now();
                    e.preventDefault();
                }

                e.stopPropagation();

                const id = btn.dataset.id;
                const action = btn.dataset.action;

                if (!id || !action) return;

                try {
                    if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                        window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    }
                } catch (err) { }

                if (action === 'remove') window.removeItem(id);
                if (action === 'decrease') window.updateQty(id, -1);
                if (action === 'increase') window.updateQty(id, 1);
            };

            // Listen for BOTH click and touchend to cover all devices reliably
            document.addEventListener('click', handleCartAction, true);
            document.addEventListener('touchend', handleCartAction, { passive: false, capture: true });
        });

        // Helper for Haptics
        function triggerHaptic(style = 'medium') {
            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                window.Telegram.WebApp.HapticFeedback.impactOccurred(style);
            }
        }

        async function loadBackendData() {
            try {
                // cache-busting with timestamp
                const t = Date.now();

                // 1. Produits
                const pRes = await fetch(`/api/products?t=${t}`);
                const pJson = await pRes.json();
                if (pJson.success && pJson.data.length > 0) {
                    products = {};
                    pJson.data.forEach(p => products[p.id] = p);
                }

                // 2. Settings (Cat√©gories, Textes, Liens)
                const sRes = await fetch(`/api/settings?t=${t}`);
                const sJson = await sRes.json();
                if (sJson.success && sJson.data) {
                    appSettings = sJson.data;

                    // Appliquer Cat√©gories
                    if (appSettings.categories) renderCategories(appSettings.categories);
                    else renderCategories(['WEED', 'HASH', 'VAPE', 'AUTRE']);

                    // Appliquer Textes Globaux
                    if (appSettings.appTitle) {
                        document.title = appSettings.appTitle;
                        const mainTitle = document.getElementById('app-main-title');
                        if (mainTitle) mainTitle.textContent = appSettings.appTitle;
                    }
                    if (appSettings.bannerText) {
                        const content = `<div class="marquee-group flex shrink-0 gap-8 pr-8"><span>${appSettings.bannerText}</span></div>`;
                        document.getElementById('promo-banner').innerHTML = `
                            <div class="marquee-track text-sm font-medium text-red-200">
                                ${content.repeat(4)}
                            </div>`;
                    }

                    // Appliquer Hero Image/Video
                    if (appSettings.heroImage) {
                        heroImages = [appSettings.heroImage];
                        // Re-init carousel if needed or just let initHeaderCarousel pick it up
                        // Since initHeaderCarousel is called AFTER this, updating heroImages array is enough
                    }

                    // Appliquer Contacts & Liens
                    if (appSettings.contact) {
                        if (appSettings.contact.telegramPrivate) orderUrl = appSettings.contact.telegramPrivate;

                        // Update buttons
                        // Update buttons
                        const tgBtn = document.querySelector('a[href*="t.me/hashfiltered"]'); // Select generic
                        if (tgBtn && appSettings.contact.telegramChannel) tgBtn.href = appSettings.contact.telegramChannel;

                        const instaBtn = document.querySelector('a[href*="instagram.com"]');
                        if (instaBtn && appSettings.contact.instagram) instaBtn.href = appSettings.contact.instagram;

                        const privateBtn = document.querySelector('a[href*="t.me/"]'); // Catch-all for first button if not specific
                        // A more specific selector for the "Telegram Prive" button:
                        // It is the 1st link in the contact modal.
                        // The modal structure: .space-y-3 > a (Telegram), a (Telegram Canal), a (Instagram)
                        // DISABLED: Hardcoded links in HTML are newer than backend data for now.
                        /*
                        const contactLinks = document.querySelectorAll('#contact-modal-overlay a');
                        if (contactLinks.length >= 3) {
                            if (appSettings.contact.telegramPrivate) {
                                contactLinks[0].href = appSettings.contact.telegramPrivate;
                                contactLinks[0].onclick = () => window.openExternalLink(appSettings.contact.telegramPrivate);
                            }
                            if (appSettings.contact.telegramChannel) {
                                contactLinks[1].href = appSettings.contact.telegramChannel;
                                contactLinks[1].onclick = () => window.openExternalLink(appSettings.contact.telegramChannel);
                            }
                            if (appSettings.contact.instagram) {
                                contactLinks[2].href = appSettings.contact.instagram;
                                contactLinks[2].onclick = () => window.openExternalLink(appSettings.contact.instagram);
                            }
                        }
                        */

                        // Save Splash settings for next reload
                        if (appSettings.splash) {
                            localStorage.setItem('splashSettings', JSON.stringify(appSettings.splash));
                        }
                    }
                }
            } catch (e) {
                console.error("Mode offline ou erreur serveur", e);
                renderCategories(['WEED', 'HASH', 'VAPE', 'AUTRE']);
            }

            // Render Dynamic Checkout Options
            renderShippingOptions();
        }

        function renderCategories(cats) {
            const container = document.getElementById('category-scroll-container');
            container.innerHTML = '';
            cats.forEach((c, index) => {
                const btn = document.createElement('button');
                btn.className = 'cat-pill ripple-effect';
                btn.textContent = c.charAt(0).toUpperCase() + c.slice(1).toLowerCase(); // Capitalize visually
                btn.onclick = () => toggleFilter(btn, c); // Keep original case for logic if needed, or match backend
                btn.style.animationDelay = `${index * 0.1}s`;
                container.appendChild(btn);
            });
        }

        // --- PRELOAD ESSENTIAL CONTENT ---
        async function preloadEssentialContent(onProgress) {
            const itemsToLoad = [];

            // 1. Banner home
            itemsToLoad.push({
                url: 'uploads/banner_home.jpg',
                type: 'image'
            });

            // 2. Product thumbnails + first 2 videos of each product
            Object.values(products).forEach(product => {
                // Thumbnail (first image)
                if (product.images && product.images[0]) {
                    itemsToLoad.push({
                        url: product.images[0],
                        type: 'image'
                    });
                }

                // First 2 videos from mediaMap
                if (product.mediaMap) {
                    const allMedia = [];
                    Object.values(product.mediaMap).forEach(mediaArray => {
                        if (Array.isArray(mediaArray)) {
                            allMedia.push(...mediaArray);
                        }
                    });

                    const videos = allMedia.filter(url =>
                        url && (url.endsWith('.mp4') || url.endsWith('.webm') || url.endsWith('.mov'))
                    ).slice(0, 2); // Only first 2 videos

                    videos.forEach(url => {
                        itemsToLoad.push({ url, type: 'video' });
                    });
                }
            });

            console.log(`[PRELOAD] Starting preload of ${itemsToLoad.length} items...`);

            // Load with progress tracking
            let loaded = 0;
            const total = itemsToLoad.length;

            const loadPromises = itemsToLoad.map(async (item) => {
                try {
                    if (item.type === 'image') {
                        await new Promise((resolve) => {
                            const img = new Image();
                            img.onload = resolve;
                            img.onerror = resolve; // Continue even if fails
                            img.src = item.url;
                        });
                    } else if (item.type === 'video') {
                        await new Promise((resolve) => {
                            const video = document.createElement('video');
                            video.preload = 'auto';
                            video.muted = true; // Required for autoplay policy
                            video.onloadeddata = resolve;
                            video.onerror = resolve; // Continue even if fails
                            video.src = item.url;
                            video.load();
                        });
                    }
                } catch (e) {
                    console.warn('[PRELOAD] Failed:', item.url);
                }

                loaded++;
                if (onProgress) {
                    const progress = (loaded / total) * 100;
                    onProgress(progress);
                }
            });

            await Promise.all(loadPromises);
            console.log('[PRELOAD] Complete!');
        }

        async function initSplash() {
            const splash = document.getElementById('splash-screen');
            const bar = document.getElementById('loading-bar-progress');
            const vid = document.getElementById('splash-logo');

            if (!splash) return;

            // --- SETTINGS LOAD ---
            let duration = 3;
            let blur = 10;

            try {
                const saved = localStorage.getItem('splashSettings');
                if (saved) {
                    const s = JSON.parse(saved);
                    // Apply Media
                    if (s.media && vid) {
                        const source = vid.querySelector('source');
                        if (source) {
                            source.src = s.media;
                        } else {
                            vid.src = s.media;
                        }
                        vid.load();
                    }
                    if (s.duration) duration = parseFloat(s.duration);
                    if (s.blur !== undefined) blur = parseInt(s.blur);
                }
            } catch (e) { console.error('Splash config error', e); }

            // Apply Blur Initial State
            splash.style.backdropFilter = `blur(${blur}px)`;
            splash.style.webkitBackdropFilter = `blur(${blur}px)`;

            // --- PRELOAD CONTENT WITH REAL PROGRESS ---
            try {
                await preloadEssentialContent((progress) => {
                    bar.style.transition = 'width 0.3s ease';
                    bar.style.width = `${Math.min(progress, 95)}%`; // Cap at 95% until final
                });
            } catch (e) {
                console.error('[PRELOAD] Error:', e);
            }

            // Final animation to 100%
            bar.style.transition = 'width 0.5s ease';
            bar.style.width = '100%';

            const startExit = (delayBeforeFade) => {
                const vid = document.getElementById('splash-logo');

                // Wait for specified delay, then start synchronized fade
                setTimeout(() => {
                    // Everything fades together: colors + blur + logo (2.5s smooth fade)
                    splash.style.transition = 'opacity 2.5s ease-in-out';
                    splash.style.opacity = '0';

                    // Logo fades with same timing
                    if (vid) {
                        vid.style.transition = 'opacity 2.5s ease-in-out';
                        vid.style.opacity = '0';
                    }

                    // Remove from DOM after fade completes
                    setTimeout(() => {
                        splash.style.display = 'none';
                    }, 2500);
                }, delayBeforeFade * 1000);
            };

            if (vid && vid.tagName === 'VIDEO') {
                vid.playbackRate = 1.0;
                vid.play().catch(() => console.log('Autoplay blocked'));
                startExit(0.5); // Start fade 0.5s after preload
            } else {
                startExit(0.5); // Start fade 0.5s after preload
            }
        }

        function initProductGrid() {
            productGrid.innerHTML = '';
            const allProducts = Object.values(products);
            const displayed = currentFilter ? allProducts.filter(p => p.category === currentFilter) : allProducts;
            if (displayed.length === 0) {
                productGrid.innerHTML = `<div class="col-span-2 text-center py-10 text-gray-500">Aucun produit dans cette cat√©gorie.</div>`;
                return;
            }
            displayed.forEach(p => {
                const el = document.createElement('div');
                el.className = 'bento-card relative flex flex-col h-64 cursor-pointer group';
                // Placeholder par d√©faut si pas d'image
                let imgUrl = (p.images && p.images.length) ? p.images[0] : 'https://placehold.co/400x300/222/FFF?text=No+Image';
                const minPrice = Math.min(...Object.values(p.prices).filter(x => x));
                el.innerHTML = `
                    <div class="h-40 w-full overflow-hidden relative">
                        <img src="${imgUrl}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy">
                        ${p.extraInfo ? `<div class="absolute top-2 left-2 text-white text-[10px] font-bold px-2 py-1 rounded-md uppercase shadow-lg" style="background-color: ${p.extraInfoColor || '#ef4444'}">${p.extraInfo}</div>` : ''}
                    </div>
                    <div class="p-3 flex-1 flex flex-col justify-between bg-gradient-to-b from-transparent to-black/20">
                        <div>
                            <h3 class="font-bold text-white text-sm leading-tight mb-1">${p.name}</h3>
                            <p class="text-xs text-gray-400">${p.category}</p>
                        </div>
                        <div class="flex justify-between items-end mt-2">
                            <span class="font-bold text-white">${minPrice}‚Ç¨+</span>
                            <button class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white hover:text-black transition-colors">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                    </div>
                `;
                el.onclick = () => openProduct(p);
                productGrid.appendChild(el);
            });
        }

        function openProduct(p) {
            currentProduct = p;
            selectedVariety = null;
            selectedWeight = null;
            isSheetCollapsed = false;
            productSheet.classList.remove('collapsed');
            productSheet.style.transform = '';
            toggleBodyScroll(true); // Lock Scroll
            document.getElementById('product-name').textContent = p.name;
            document.getElementById('product-category').textContent = p.category;
            const farmContainer = document.getElementById('product-farm-container');
            if (p.farm) {
                document.getElementById('product-farm').textContent = p.farm;
                farmContainer.classList.remove('hidden');
            } else {
                farmContainer.classList.add('hidden');
            }
            const descEl = document.getElementById('product-description');
            if (p.description) {
                descEl.textContent = p.description;
                descEl.classList.remove('hidden');

                // Position Logic
                const optionsEl = document.getElementById('product-options');
                const container = descEl.parentElement;

                if (p.descPosition === 'bottom') {
                    // Insert after options
                    if (optionsEl.nextSibling) container.insertBefore(descEl, optionsEl.nextSibling);
                    else container.appendChild(descEl);
                } else {
                    // Insert before options (Default)
                    container.insertBefore(descEl, optionsEl);
                }

            } else {
                descEl.classList.add('hidden');
            }
            buildCarousel();
            const optsContainer = document.getElementById('product-options');
            optsContainer.innerHTML = '';
            if (p.varieties && p.varieties.length > 0) {
                const varDiv = document.createElement('div');
                varDiv.innerHTML = `<h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Vari√©t√©</h4>`;
                const varGrid = document.createElement('div');
                varGrid.className = 'flex flex-wrap gap-2';
                selectedVariety = p.varieties[0];
                p.varieties.forEach((v, idx) => {
                    const btn = document.createElement('button');
                    btn.className = `option-btn variety-btn px-4 ${idx === 0 ? 'active' : ''}`;
                    btn.textContent = v;
                    btn.dataset.variety = v;
                    btn.onclick = () => { scrollToVariety(v); };
                    varGrid.appendChild(btn);
                });
                varDiv.appendChild(varGrid);
                optsContainer.appendChild(varDiv);
            } else {
                selectedVariety = p.name;
            }
            const wDiv = document.createElement('div');
            wDiv.innerHTML = `<h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Quantit√©</h4>`;
            const wGrid = document.createElement('div');
            wGrid.className = 'option-grid';
            selectedWeight = Object.keys(p.prices)[0];
            Object.keys(p.prices).forEach((w, idx) => {
                const btn = document.createElement('button');
                btn.className = `option-btn ${idx === 0 ? 'active' : ''}`;
                btn.innerHTML = `<div class="text-sm">${w}</div><div class="text-xs text-gray-400">${p.prices[w]}‚Ç¨</div>`;
                btn.onclick = () => {
                    selectedWeight = w;
                    wGrid.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                };
                wGrid.appendChild(btn);
            });
            wDiv.appendChild(wGrid);
            optsContainer.appendChild(wDiv);
            productPage.classList.add('active');
            scrollToVariety(selectedVariety);
        }

        function buildCarousel() {
            carouselTrack.innerHTML = '';
            slideToVarietyMap = [];
            currentSlide = 0;
            const addSlide = (src, varietyName) => {
                const div = document.createElement('div');
                div.className = 'w-full h-full flex-shrink-0 flex items-center justify-center';
                // Si placeholder ou image valide
                if (src.endsWith('.mp4')) {
                    div.innerHTML = `<video src="${src}" class="w-full h-full object-cover" autoplay loop muted playsinline></video>`;
                } else {
                    div.innerHTML = `<img src="${src}" class="w-full h-full object-cover">`;
                }
                carouselTrack.appendChild(div);
                slideToVarietyMap.push(varietyName);
            };
            if (currentProduct.varieties && currentProduct.varieties.length > 0) {
                currentProduct.varieties.forEach(v => {
                    let sources = currentProduct.mediaMap?.[v] || [];
                    if (sources.length === 0 && currentProduct.images) sources = currentProduct.images;
                    if (sources.length === 0) sources = ['https://placehold.co/600x800/111/FFF?text=' + v];
                    sources.forEach(s => addSlide(s, v));
                });
            } else {
                let sources = currentProduct.images || [];
                // Fallback si vide
                if (sources.length === 0) sources = ['https://placehold.co/600x800/111/FFF?text=' + currentProduct.name];
                sources.forEach(s => addSlide(s, currentProduct.name));
            }
        }

        function scrollToVariety(varietyName) {
            const index = slideToVarietyMap.indexOf(varietyName);
            if (index !== -1) {
                currentSlide = index;
                updateCarouselTransform();
                selectedVariety = varietyName;
                document.querySelectorAll('.variety-btn').forEach(btn => {
                    if (btn.dataset.variety === selectedVariety) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
            }
        }

        function updateCarouselTransform() {
            carouselTrack.style.transform = `translateX(-${currentSlide * 100}%)`;
            const currentVarietyInView = slideToVarietyMap[currentSlide];
            if (currentVarietyInView && currentVarietyInView !== selectedVariety) {
                selectedVariety = currentVarietyInView;
                document.querySelectorAll('.variety-btn').forEach(btn => {
                    if (btn.dataset.variety === selectedVariety) btn.classList.add('active');
                    else btn.classList.remove('active');
                });
            }
        }

        let currentSlide = 0;
        window.nextSlide = () => { if (currentSlide < carouselTrack.children.length - 1) { currentSlide++; updateCarouselTransform(); } };
        window.prevSlide = () => { if (currentSlide > 0) { currentSlide--; updateCarouselTransform(); } };

        function initCarouselGestures() {
            const trackContainer = document.querySelector('#carousel-track').parentElement;
            if (!trackContainer) return;
            let startX = 0;
            let isSwiping = false;
            trackContainer.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; isSwiping = true; }, { passive: true });
            trackContainer.addEventListener('touchend', (e) => {
                if (!isSwiping) return;
                const endX = e.changedTouches[0].clientX;
                const diff = startX - endX;
                if (Math.abs(diff) > 50) {
                    if (diff > 0) window.nextSlide();
                    else window.prevSlide();
                }
                isSwiping = false;
            });
        }

        let lastToggleTime = 0;
        function toggleSheet() {
            const now = Date.now();
            if (now - lastToggleTime < 300) return;
            lastToggleTime = now;

            // Ensure smooth transition for toggle
            // Using Double RAF pattern to ensure browser paints transition property before class change
            productSheet.style.transition = 'transform 0.5s cubic-bezier(0.32, 0.72, 0, 1)';

            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    isSheetCollapsed = !isSheetCollapsed;
                    if (isSheetCollapsed) {
                        productSheet.classList.add('collapsed');
                    } else {
                        productSheet.classList.remove('collapsed');
                    }
                });
            });
        }

        // --- FLUID CLOSING LOGIC (iOS Style) ---
        function seamlessClose(element, removeClass = 'active', addClass = '') {
            if (!element) return;

            // 1. Lire la position r√©elle actuelle
            const style = window.getComputedStyle(element);
            const matrix = new DOMMatrixReadOnly(style.transform);
            const currentY = matrix.m42;

            // 2. Figer l'√©l√©ment √† cette position
            element.style.transition = 'none';
            element.style.transform = `translateY(${currentY}px)`;

            // Force Reflow (Lecture d'une propri√©t√© g√©om√©trique)
            // Cela oblige le navigateur √† appliquer le style ci-dessus AVANT de passer √† la suite.
            void element.offsetHeight;

            // 3. Forcer le reflow et lancer l'animation de sortie
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    element.style.transition = 'transform 0.5s cubic-bezier(0.32, 0.72, 0, 1)';
                    element.style.transform = 'translateY(100%)';

                    if (removeClass) element.classList.remove(removeClass);
                    if (addClass) element.classList.add(addClass);

                    // Nettoyage apr√®s animation
                    const cleanup = () => {
                        // On retire le style inline pour laisser le CSS g√©rer l'√©tat ferm√©
                        // (si l'√©l√©ment est toujours ferm√©)
                        if ((addClass && element.classList.contains(addClass)) || (removeClass && !element.classList.contains(removeClass))) {
                            element.style.transform = '';
                        }
                        element.removeEventListener('transitionend', cleanup);
                    };
                    element.addEventListener('transitionend', cleanup, { once: true });
                });
            });
        }

        window.closeCartPage = () => {
            const el = document.getElementById('cart-page');
            seamlessClose(el, 'active', null);
            toggleBodyScroll(false); // Unlock Scroll
        };

        window.openInfoPage = () => {
            const el = document.getElementById('info-page');
            if (!el) return;

            // SAFETY RESET: Force closed state instantly first
            // This ensures the open animation ALWAYS plays, even if it was stuck
            el.style.transition = 'none';
            el.style.transform = ''; // Clear any inline transform
            el.classList.add('translate-y-full'); // Ensure CSS thinks it's closed

            // Force Reflow to apply the closed state
            void el.offsetHeight;

            // Now Animate Open
            requestAnimationFrame(() => {
                el.style.transition = 'transform 0.5s cubic-bezier(0.32, 0.72, 0, 1)';
                el.classList.remove('translate-y-full');
            });
            toggleBodyScroll(true); // Lock Scroll
        };

        window.closeInfoPage = () => {
            const el = document.getElementById('info-page');
            seamlessClose(el, null, 'translate-y-full');
            toggleBodyScroll(false); // Unlock Scroll
        };


        // --- GESTURE LOGIC REFACTOR (V2 - Smooth & Decoupled) ---

        function initSheetGestures() {
            const handleArea = document.getElementById('sheet-handle-area');
            const sheet = document.getElementById('product-content-sheet');
            let startY = 0;
            let currentTranslateY = 0;
            let isDragging = false;
            let sheetHeight = 0;
            const COLLAPSED_OFFSET = 160;

            const updatePos = (y) => {
                // Limit y to [0, maxTranslate]
                // 0 = Expanded (Top)
                // maxTranslate = Collapsed (Bottom)
                const maxTranslate = sheetHeight - COLLAPSED_OFFSET;
                let validY = Math.max(0, Math.min(y, maxTranslate));

                requestAnimationFrame(() => {
                    sheet.style.transform = `translateY(${validY}px)`;
                });
            };

            const startDrag = (y) => {
                isDragging = true;
                startY = y;
                sheetHeight = sheet.offsetHeight;

                // --- FIX JUMP GLITCH ---
                // Get the REAL current position from the computed style
                // This handles cases where we interrupt an animation or interact with CSS positioning
                const style = window.getComputedStyle(sheet);
                const matrix = new DOMMatrixReadOnly(style.transform);
                currentTranslateY = matrix.m42; // The Y translation component

                // Immediately freeze at this position
                sheet.style.transition = 'none';
                sheet.style.transform = `translateY(${currentTranslateY}px)`;
            };

            const moveDrag = (y) => {
                if (!isDragging) return;
                const delta = y - startY;
                updatePos(currentTranslateY + delta);
            };

            const endDrag = (y) => {
                if (!isDragging) return;
                isDragging = false;

                // Fluid spring-like animation
                sheet.style.transition = 'transform 0.5s cubic-bezier(0.32, 0.72, 0, 1)';

                const delta = y - startY;
                const maxTranslate = sheetHeight - COLLAPSED_OFFSET;
                const newY = currentTranslateY + delta;

                if (Math.abs(delta) < 5) {
                    // Tap = Toggle
                    toggleSheet();
                    sheet.style.transform = '';
                    return;
                }

                if (newY > maxTranslate / 2) {
                    // Closer to bottom -> Collapse (but not fully closed, strictly to collapsed state)
                    sheet.classList.add('collapsed');
                    isSheetCollapsed = true;
                } else {
                    // Closer to top -> Expand
                    sheet.classList.remove('collapsed');
                    isSheetCollapsed = false;
                }

                // Reset transform to let CSS class take over (which handles the final position)
                // Ensure CSS transition matches JS if possible, but here we set transition on element.
                // The CSS class 'collapsed' typically uses a transform or bottom/height property.
                // If we remove inline transform, it snaps to CSS state. 
                // We enabled transition above, so it should animate to the CSS state.
                sheet.style.transform = '';
            };

            handleArea.addEventListener('touchstart', (e) => { if (e.cancelable) e.preventDefault(); startDrag(e.touches[0].clientY); }, { passive: false });
            handleArea.addEventListener('touchmove', (e) => { if (e.cancelable) e.preventDefault(); moveDrag(e.touches[0].clientY); }, { passive: false });
            handleArea.addEventListener('touchend', (e) => endDrag(e.changedTouches[0].clientY));
            handleArea.addEventListener('mousedown', (e) => startDrag(e.clientY));
            window.addEventListener('mousemove', (e) => moveDrag(e.clientY));
            window.addEventListener('mouseup', (e) => endDrag(e.clientY));
            window.addEventListener('mouseup', (e) => { if (isDragging) endDrag(e.clientY); });
        }

        // --- GESTIONNAIRE UNIFI√â DES GESTES (FACTORY) ---
        // Cette fonction applique la M√äME physique partout.

        function setupSheetPhysics(handleId, sheetId, closeAction, enableDrag = true) {
            const handle = document.getElementById(handleId);
            const sheet = document.getElementById(sheetId);
            if (!handle || !sheet) return;

            let startY = 0;
            let currentTranslateY = 0;
            let isDragging = false;
            let didMove = false; // Flag to track if actual dragging occurred

            // --- CLICK OBSERVER ---
            // Ecouteur de clic natif pour une fiabilit√© √† 100% sur le "Tap"
            handle.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                // Si on n'a pas gliss√© (drag), c'est un clic -> on ferme
                if (!didMove) {
                    closeAction();
                }
            });

            const onStart = (y) => {
                isDragging = true;
                didMove = false; // Reset status
                startY = y;

                // Capture current position
                const style = window.getComputedStyle(sheet);
                const matrix = new DOMMatrixReadOnly(style.transform);
                currentTranslateY = matrix.m42;

                // Kill transition for instant tracking
                sheet.style.transition = 'none';
            };

            const onMove = (y) => {
                if (!isDragging) return;
                if (!enableDrag) return; // Feature Flag: Disable Drag

                const delta = y - startY;

                // Only consider it a "move" if executed beyond a threshold
                if (Math.abs(delta) > 10) {
                    didMove = true;
                }

                if (didMove) {
                    // Drag logic
                    const newY = Math.max(0, currentTranslateY + delta);
                    requestAnimationFrame(() => {
                        sheet.style.transform = `translateY(${newY}px)`;
                    });
                }
            };

            const onEnd = (y) => {
                if (!isDragging) return;
                isDragging = false;

                if (!didMove) {
                    // It was a static tap (or micro-move)
                    // Let the Click Observer handle it, or force it here if click is swallowed
                    closeAction();
                } else {
                    // It was a Drag
                    const delta = y - startY;
                    if (delta > 80) { // Drag Threshold
                        // Dismiss
                        sheet.style.transition = 'transform 0.3s cubic-bezier(0.32, 0.72, 0, 1)';
                        sheet.style.transform = 'translateY(100%)';
                        // Trigger logical close after animation
                        setTimeout(() => closeAction(), 300);
                    } else {
                        // Snap Back
                        sheet.style.transition = 'transform 0.4s cubic-bezier(0.32, 0.72, 0, 1)';
                        sheet.style.transform = '';
                    }
                }
            };

            // Touch Events
            handle.addEventListener('touchstart', (e) => {
                // Do NOT preventDefault here, otherwise 'click' event never fires
                onStart(e.touches[0].clientY);
            }, { passive: true });

            handle.addEventListener('touchmove', (e) => {
                // Prevent scrolling while dragging
                if (isDragging && didMove) e.preventDefault();
                onMove(e.touches[0].clientY);
            }, { passive: false });

            handle.addEventListener('touchend', (e) => {
                onEnd(e.changedTouches[0].clientY);
            });

            // Mouse Events
            handle.addEventListener('mousedown', (e) => onStart(e.clientY));
            window.addEventListener('mousemove', (e) => { if (isDragging) onMove(e.clientY); });
            window.addEventListener('mouseup', (e) => { if (isDragging) onEnd(e.clientY); });
        }

        // --- INITIALISATION DES GESTES ---

        function initCartGestures() {
            setupSheetPhysics('cart-handle-area', 'cart-page', window.closeCartPage);
        }

        function initInfoPageGestures() {
            // Disable Drag (false), Keep Click/Tap Interaction
            setupSheetPhysics('info-handle-area', 'info-page', window.closeInfoPage, false);
        }


        // --- FULLSCREEN MEDIA LOGIC ---
        window.openFullscreenMedia = () => {
            const overlay = document.getElementById('fullscreen-media-overlay');
            const track = document.getElementById('fullscreen-carousel-track');
            if (!overlay || !track || !currentProduct) return;

            track.innerHTML = '';

            let sources = [];
            if (currentProduct.varieties && currentProduct.varieties.length > 0) {
                currentProduct.varieties.forEach(v => {
                    let varietySources = currentProduct.mediaMap?.[v] || [];
                    if (varietySources.length > 0) sources.push(...varietySources);
                });
                if (sources.length === 0 && currentProduct.images) sources = currentProduct.images;
            } else {
                sources = currentProduct.images || [];
            }

            sources = [...new Set(sources)];
            if (sources.length === 0) sources = ['https://placehold.co/600x800/111/FFF?text=' + currentProduct.name];

            sources.forEach(src => {
                const slide = document.createElement('div');
                slide.className = 'fullscreen-slide';

                if (src.endsWith('.mp4')) {
                    slide.innerHTML = `<video src="${src}" controls autoplay loop playsinline class="max-w-full max-h-full"></video>`;
                } else {
                    slide.innerHTML = `<img src="${src}" class="max-w-full max-h-full object-contain">`;
                }
                track.appendChild(slide);
            });

            overlay.classList.add('active');
        };

        window.closeFullscreenMedia = () => {
            const overlay = document.getElementById('fullscreen-media-overlay');
            const track = document.getElementById('fullscreen-carousel-track');
            if (overlay) overlay.classList.remove('active');
            if (track) {
                setTimeout(() => {
                    track.innerHTML = '';
                }, 300);
            }
        };

        // Contact Modal Scroll Lock
        const contactOverlay = document.getElementById('contact-modal-overlay');
        if (contactOverlay) {
            contactOverlay.addEventListener('touchmove', (e) => {
                e.preventDefault(); // Block background scroll
            }, { passive: false });
        }

        window.toggleFilter = (btn, cat) => {
            triggerHaptic('light'); // Vibration l√©g√®re
            if (currentFilter === cat) { currentFilter = null; btn.classList.remove('active'); }
            else { currentFilter = cat; document.querySelectorAll('.cat-pill').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            initProductGrid();
        };

        document.getElementById('add-to-cart-btn').onclick = () => {
            triggerHaptic('medium');
            if (!selectedVariety || !selectedWeight) return showToast("S√©lection incompl√®te", "error");
            const id = `${currentProduct.id}-${selectedVariety}-${selectedWeight}`;

            let img = null;
            if (currentProduct.images && currentProduct.images.length > 0) img = currentProduct.images[0];

            if (cartItems[id]) { cartItems[id].quantity++; } else {
                cartItems[id] = { id, name: currentProduct.name, variety: selectedVariety, weight: selectedWeight, price: currentProduct.prices[selectedWeight], quantity: 1, image: img };
            }
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            updateCartCount();
            window.hideProduct();
            showToast("Ajout√© au panier !");
        };

        document.getElementById('buy-now-btn').onclick = () => {
            triggerHaptic('medium');
            if (!selectedVariety || !selectedWeight) return showToast("S√©lection incompl√®te", "error");
            const id = `${currentProduct.id}-${selectedVariety}-${selectedWeight}`;

            let img = null;
            if (currentProduct.images && currentProduct.images.length > 0) img = currentProduct.images[0];

            if (cartItems[id]) { cartItems[id].quantity++; } else {
                cartItems[id] = { id, name: currentProduct.name, variety: selectedVariety, weight: selectedWeight, price: currentProduct.prices[selectedWeight], quantity: 1, image: img };
            }
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            updateCartCount();
            window.hideProduct();
            window.openCartPage();
        };

        window.openCartPage = () => {
            triggerHaptic('light');
            renderCart();

            // NUCLEAR RESET FOR CART
            cartPage.removeAttribute('style');
            void cartPage.offsetHeight; // Force reflow

            cartPage.classList.add('active');
            toggleBodyScroll(true); // Lock Scroll

            // FORCE DEFAULT SELECTION (Fix for persistent options)
            setTimeout(() => {
                if (!selectedShipping) {
                    const deliveryBtn = document.querySelector('.shipping-btn');
                    if (deliveryBtn) {
                        selectShipping('delivery', deliveryBtn);
                    }
                }
            }, 100);
        };

        function renderCart() {
            const container = document.getElementById('cart-items-page');
            const checkoutOpts = document.getElementById('checkout-options-container');
            container.innerHTML = '';

            // Reduce gap
            if (checkoutOpts) {
                checkoutOpts.classList.remove('mt-4');
                checkoutOpts.classList.add('mt-2');
            }

            const items = Object.values(cartItems);
            let subtotal = 0;
            if (items.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-64 text-gray-500"><i class="fas fa-shopping-basket text-4xl mb-4 opacity-50"></i><p>Votre panier est vide</p></div>`;
                document.getElementById('cart-total-page').textContent = "0‚Ç¨";
                checkoutOpts.classList.add('hidden');
                return;
            }
            checkoutOpts.classList.remove('hidden');
            items.forEach((item) => {
                subtotal += item.price * item.quantity;
                const el = document.createElement('div');
                el.className = 'bento-card p-3 flex items-center gap-3';

                let imgHtml = `<div class="w-16 h-16 bg-white/5 rounded-xl flex items-center justify-center text-xl font-bold text-gray-700">${item.name.charAt(0)}</div>`;
                if (item.image) {
                    if (item.image.endsWith('.mp4') || item.image.endsWith('.webm')) {
                        imgHtml = `<video src="${item.image}" class="w-16 h-16 rounded-xl object-cover" muted loop autoplay playsinline></video>`;
                    } else {
                        imgHtml = `<img src="${item.image}" class="w-16 h-16 rounded-xl object-cover">`;
                    }
                }

                const encodedId = encodeURIComponent(item.id);

                // Calculate Total Weight
                let displayWeight = item.weight;
                const weightMatch = item.weight.match(/(\d+(\.\d+)?)/);
                if (weightMatch) {
                    const unitVal = parseFloat(weightMatch[0]);
                    const unitStr = item.weight.replace(weightMatch[0], '').trim();
                    const totalVal = unitVal * item.quantity;
                    // Format cleanup: avoid long decimals
                    displayWeight = (Math.round(totalVal * 100) / 100) + unitStr;
                }

                // --- INDEX STRATEGY (Bulletproof) ---
                // We use the index of the item in the current render loop to avoid ID parsing issues in HTML attributes.
                el.innerHTML = `
                    ${imgHtml}
                    <div class="flex-1"><h4 class="font-bold text-white leading-tight">${item.name}</h4><p class="text-xs text-gray-400">${item.variety} - ${displayWeight}</p><p class="text-sm font-bold mt-1 text-white">${item.price * item.quantity}‚Ç¨</p></div>`;

                // --- ROBUST DOM BUTTON CREATION (No HTML String issues, Bigger Touch Targets) ---
                const actionDiv = document.createElement('div');
                actionDiv.className = 'flex flex-col items-end gap-2';
                actionDiv.style.position = 'relative';
                actionDiv.style.zIndex = '50';

                // Helper to create safe button
                const createBtn = (cls, act, html) => {
                    const b = document.createElement('button');
                    b.type = 'button';
                    b.className = 'cart-btn ' + cls;
                    b.dataset.action = act;
                    b.dataset.id = item.id;
                    b.innerHTML = html;
                    // Styles for robustness
                    b.style.position = 'relative';
                    b.style.zIndex = '9999';
                    b.style.pointerEvents = 'auto';
                    b.style.touchAction = 'manipulation';
                    b.style.webkitUserSelect = 'none';
                    b.style.userSelect = 'none';
                    return b;
                };

                const removeBtn = createBtn('text-gray-500 hover:text-red-500 text-xs p-2', 'remove', '<i class="fas fa-trash pointer-events-none"></i>');

                const qtyDiv = document.createElement('div');
                qtyDiv.className = 'bg-white/10 rounded-lg flex items-center';
                qtyDiv.style.position = 'relative';
                qtyDiv.style.zIndex = '50';

                // Bigger touch targets (w-10 h-10)
                const minusBtn = createBtn('w-10 h-10 flex items-center justify-center text-xs active:bg-white/20 rounded-l-lg transition-colors', 'decrease', '-');

                const qtySpan = document.createElement('span');
                qtySpan.className = 'text-xs font-bold w-6 text-center';
                qtySpan.textContent = item.quantity;

                const plusBtn = createBtn('w-10 h-10 flex items-center justify-center text-xs active:bg-white/20 rounded-r-lg transition-colors', 'increase', '+');

                qtyDiv.appendChild(minusBtn);
                qtyDiv.appendChild(qtySpan);
                qtyDiv.appendChild(plusBtn);

                actionDiv.appendChild(removeBtn);
                actionDiv.appendChild(qtyDiv);

                el.appendChild(actionDiv);
                container.appendChild(el);
            });

            // Cleanup: No inline listeners needed. Global document delegation handles this now.
            let shippingCost = 0;

            // I will add the delegation script below `window.updateQty` definition or inside `DOMContentLoaded`.
            // For now, I'll just change the HTML here. I will proceed to add delegation in the next chunk.
            // Dynamic Shipping Cost Logic
            let shippingLabel = "";
            if (selectedShipping === 'delivery') { // Assuming 'delivery' type in JSON
                // Usually FREE or Fixed? 
                // If Modifieur settings don't have cost for delivery type, defaults to 0.
                // We don't have a cost for basic shipping selection yet, only carrier.
                // If selectedShipping is 'delivery', we usually don't have carriers. 
                // But let's check if there is a carrier selected (unlikely for delivery mode based on current data)
            } else if (selectedShipping === 'shipping' && selectedCarrier) {
                shippingCost = selectedCarrierCost;
                shippingLabel = selectedCarrier;
            } else {
                // Fallback for old hardcoded values if not set? No, cleaner to rely on variables.
                // If manually set via selectCarrier, variables are set.

                // If we are in 'Shipping' mode (from button click 'selectShipping')
                // and we have a carrier selected.
                // Note: selectShipping stores 'delivery' or 'shipping' (lowercase or uppercase? Check renderShippingOptions)
                // renderShippingOptions uses opt.type. Default JSON says "delivery", "shipping".
            }
            const total = subtotal + shippingCost;
            const totalEl = document.getElementById('cart-total-page');
            if (shippingCost > 0) {
                totalEl.innerHTML = `<div class="flex flex-col items-end"><span class="text-xs text-gray-400">${subtotal}‚Ç¨ + ${shippingCost}‚Ç¨ (${shippingLabel})</span><span>${total}‚Ç¨</span></div>`;
            } else {
                totalEl.textContent = total + "‚Ç¨";
            }
        }



        window.updateQty = (id, delta) => {
            // Internal use or direct call backup
            if (cartItems[id]) {
                cartItems[id].quantity = parseInt(cartItems[id].quantity || 0) + delta;
                if (cartItems[id].quantity <= 0) delete cartItems[id];
                localStorage.setItem('cartItems', JSON.stringify(cartItems));
                renderCart();
                updateCartCount();
            }
        };

        window.removeItem = (id) => {
            triggerHaptic('medium');
            delete cartItems[id]; localStorage.setItem('cartItems', JSON.stringify(cartItems)); renderCart(); updateCartCount();
        };

        window.openInfoPage = () => { document.getElementById('info-page').classList.remove('translate-y-full'); toggleBodyScroll(true); };
        window.closeInfoPage = () => {
            const hp = document.getElementById('info-page');
            hp.style.transition = 'transform 0.45s cubic-bezier(0.32, 0.72, 0, 1)';
            hp.classList.add('translate-y-full');
            toggleBodyScroll(false);
        };

        window.saveUserInfo = () => {
            triggerHaptic('light');
            const pseudoInput = document.getElementById('input-pseudo');
            const nomInput = document.getElementById('input-nom');
            const prenomInput = document.getElementById('input-prenom');
            const adresseInput = document.getElementById('input-adresse');
            const villeInput = document.getElementById('input-ville');
            const zipInput = document.getElementById('input-zip');
            const whatsappInput = document.getElementById('input-whatsapp');
            const emailInput = document.getElementById('input-email');

            const inputs = [pseudoInput, nomInput, prenomInput, adresseInput, villeInput, zipInput, whatsappInput, emailInput];

            // Reset styles
            inputs.forEach(el => el.classList.remove('input-error'));

            if (pseudoInput.value.trim().length < 3) {
                triggerHaptic('error'); pseudoInput.classList.add('input-error'); return showToast("Pseudo invalide", "error");
            }
            if (nomInput.value.trim().length < 2) {
                triggerHaptic('error'); nomInput.classList.add('input-error'); return showToast("Nom manquant", "error");
            }
            if (prenomInput.value.trim().length < 2) {
                triggerHaptic('error'); prenomInput.classList.add('input-error'); return showToast("Pr√©nom manquant", "error");
            }
            if (adresseInput.value.trim().length < 5) {
                triggerHaptic('error'); adresseInput.classList.add('input-error'); return showToast("Adresse incompl√®te", "error");
            }
            if (villeInput.value.trim().length < 2) {
                triggerHaptic('error'); villeInput.classList.add('input-error'); return showToast("Ville manquante", "error");
            }
            if (zipInput.value.trim().length < 4) {
                triggerHaptic('error'); zipInput.classList.add('input-error'); return showToast("Code postal invalide", "error");
            }
            if (whatsappInput.value.trim().length < 6) {
                triggerHaptic('error'); whatsappInput.classList.add('input-error'); return showToast("Num√©ro WhatsApp requis pour le livreur", "error");
            }
            // Email optionnel ? Laissons le g√©n√©rique ou check simple
            if (emailInput.value.trim().length > 0 && emailInput.value.trim().length < 5) {
                triggerHaptic('error'); emailInput.classList.add('input-error'); return showToast("Email invalide", "error");
            }

            userInfo = {
                pseudo: pseudoInput.value.trim(),
                nom: nomInput.value.trim(),
                prenom: prenomInput.value.trim(),
                adresse: adresseInput.value.trim(),
                ville: villeInput.value.trim(),
                zip: zipInput.value.trim(),
                whatsapp: whatsappInput.value.trim(),
                email: emailInput.value.trim()
            };

            window.closeInfoPage();
            showToast("Informations enregistr√©es !");

            const btn = document.getElementById('btn-open-info');
            if (btn) {
                btn.classList.remove('bg-blue-600/20', 'text-blue-400', 'border-blue-500/50');
                btn.classList.add('bg-green-600/20', 'text-green-400', 'border-green-500/50');
                btn.innerHTML = `<i class="fas fa-check"></i> Informations Valides`;
            }
        };

        window.placeOrder = async () => {
            triggerHaptic('heavy'); // Grosse vibration pour action finale
            const items = Object.values(cartItems);
            if (items.length === 0) return showToast("Panier vide", "error");

            // Check minimum order amount (50‚Ç¨)
            const cartTotal = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            if (cartTotal < 50) return showToast("minimum 50‚Ç¨ d'achat", "error");

            if (!selectedShipping) return showToast("Choisissez la livraison", "error");
            if (!selectedPayment) return showToast("Choisissez le paiement", "error");
            // Validation STRICTE pour la Livraison ET l'Envoi (Meetup exempt√© de coordonn√©es)
            if (selectedShipping === 'shipping' || selectedShipping === 'delivery') {
                if (selectedShipping === 'shipping' && !selectedCarrier) return showToast("Option de livraison manquante", "error");

                // Auto-capture & Validate if not saved yet
                if (!userInfo || !userInfo.pseudo) {
                    const pseudo = document.getElementById('input-pseudo').value.trim();
                    const nom = document.getElementById('input-nom').value.trim();
                    const prenom = document.getElementById('input-prenom').value.trim();
                    const adresse = document.getElementById('input-adresse').value.trim();
                    const ville = document.getElementById('input-ville').value.trim();
                    const zip = document.getElementById('input-zip').value.trim();
                    const whatsapp = document.getElementById('input-whatsapp').value.trim();
                    const email = document.getElementById('input-email').value.trim();

                    // Verification champs obligatoires
                    let missing = false;
                    if (pseudo.length < 3) missing = true;
                    if (nom.length < 2) missing = true;
                    if (prenom.length < 2) missing = true;
                    if (adresse.length < 5) missing = true;
                    if (ville.length < 2) missing = true;
                    if (zip.length < 4) missing = true;
                    if (whatsapp.length < 6) missing = true;

                    if (missing) {
                        window.openInfoPage();
                        window.saveUserInfo(); // Trigger visual errors
                        return showToast("Nom, Pr√©nom, Adresse complets requis !", "error");
                    }

                    userInfo = { pseudo, nom, prenom, adresse, ville, zip, whatsapp, email };
                }
            } else if (selectedShipping === 'meetup') {
                // Pour Meetup, on peut demander juste un pseudo si pas encore set, ou rien.
                // Le client demande de ne PAS demander les infos.
                // On check juste si on a un pseudo via Telegram, sinon on met "Anonyme" ou on laisse vide.
                if (!userInfo || !userInfo.pseudo) {
                    let pseudo = document.getElementById('input-pseudo').value.trim();
                    if (pseudo.length < 2) pseudo = "Client Meetup";
                    userInfo = { pseudo: pseudo, nom: "", prenom: "", adresse: "Meetup", ville: "", zip: "", whatsapp: "", email: "" };
                }
            }

            // Calculate totals







            // --- EMOJI ENCODING FIX (String.fromCodePoint) ---
            const fromCP = (...codes) => String.fromCodePoint(...codes);

            const getCategoryEmoji = (txt) => {
                const t = (txt || '').toLowerCase();
                // Drapeaux
                if (t.includes('canada')) return fromCP(0x1F1E8, 0x1F1E6); // CA
                if (t.includes('usa') || t.includes('cali')) return fromCP(0x1F1FA, 0x1F1F8); // US
                if (t.includes('spain') || t.includes('espagne')) return fromCP(0x1F1EA, 0x1F1F8); // ES
                if (t.includes('maroc') || t.includes('beldia')) return fromCP(0x1F1F2, 0x1F1E6); // MA

                // Cat√©gories
                if (t.includes('fleur') || t.includes('weed') || t.includes('beuh')) return fromCP(0x1F966); // Broccoli
                if (t.includes('hash') || t.includes('shit') || t.includes('dry') || t.includes('filtre')) return fromCP(0x1F36B); // Chocolate
                if (t.includes('vape') || t.includes('pen') || t.includes('puff')) return fromCP(0x1F58A, 0xFE0F); // Pen
                if (t.includes('edible') || t.includes('gumm') || t.includes('bonbon')) return fromCP(0x1F36C); // Candy
                if (t.includes('concentr') || t.includes('wax')) return fromCP(0x1F36F); // Honey
                if (t.includes('preroll')) return fromCP(0x1F6AC); // Cigarette

                return fromCP(0x1F4E6); // Box
            };

            const getVarietyEmoji = (txt) => {
                const t = (txt || '').toLowerCase();
                if (t.includes('frozen')) return fromCP(0x2744, 0xFE0F); // Snowflake
                if (t.includes('static')) return fromCP(0x26A1); // Zap
                if (t.includes('cookie')) return fromCP(0x1F36A); // Cookie
                if (t.includes('lemon')) return fromCP(0x1F34B); // Lemon
                if (t.includes('purple')) return fromCP(0x1F940); // Wilted Flower
                if (t.includes('orange') || t.includes('mimosa') || t.includes('tangerine')) return fromCP(0x1F34A); // Tangerine
                if (t.includes('berry') || t.includes('cherry') || t.includes('grape')) return fromCP(0x1F352); // Cherries
                if (t.includes('banana')) return fromCP(0x1F34C); // Banana
                if (t.includes('zkittlez') || t.includes('candy') || t.includes('runts')) return fromCP(0x1F36C); // Candy
                if (t.includes('gelato') || t.includes('ice') || t.includes('cream')) return fromCP(0x1F367); // Shaved Ice
                if (t.includes('gas') || t.includes('diesel') || t.includes('fuel')) return fromCP(0x26FD); // Fuel Pump
                return '';
            };

            let subtotal = 0;
            let msg = "Salut Full Terps Exotica ! ‚òÅÔ∏è\nVoici ma commande :\n";

            // 1. Infos Client
            if (userInfo) {
                if (userInfo.pseudo) msg += `@${userInfo.pseudo.replace(/^@/, '')}\n`;
                if (userInfo.adresse) msg += `${fromCP(0x1F3E1)} ${userInfo.adresse}\n`; // House
                if (userInfo.ville) msg += `${fromCP(0x1F306)} ${userInfo.ville} ${userInfo.zip ? '(' + userInfo.zip + ')' : ''}\n`; // Cityscape
                if (userInfo.whatsapp) msg += `${fromCP(0x1F7E9)} WhatsApp: ${userInfo.whatsapp}\n`; // Green Square
                if (userInfo.email) msg += `${fromCP(0x1F4E9)} ${userInfo.email}\n`; // Envelope
            }
            msg += "\n";

            // 2. Produits
            items.forEach(i => {
                const pPrice = i.price * i.quantity;
                subtotal += pPrice;

                const fullDesc = ((i.category || '') + ' ' + (i.name || '')).toLowerCase();
                const catEmoji = getCategoryEmoji(fullDesc);

                let varEmoji = getVarietyEmoji(i.variety);
                if (!varEmoji) varEmoji = getVarietyEmoji(i.name);

                let nameDisplay = i.name;
                if (i.variety && !i.name.toLowerCase().includes(i.variety.toLowerCase())) {
                    nameDisplay += ` ${i.variety}`;
                }

                let line = `${catEmoji} ${i.weight} ${nameDisplay} ${varEmoji}`;
                if (i.quantity > 1) line += ` x${i.quantity}`;
                msg += `${line}\n`;
            });

            // 3. Livraison & Paiement
            let shippingCost = 0;
            let shippingLabel = "";
            let shipEmoji = `${fromCP(0x1F69A)} Livraison`; // Delivery Truck

            if (selectedShipping === 'shipping') {
                const cost = 25;
                shippingCost = cost;
                shippingLabel = selectedCarrier;
                shipEmoji = `${fromCP(0x1F4E6)} Envoi`; // Box
                msg += `\n${shipEmoji} (${shippingLabel}: +${cost}‚Ç¨)`;
            } else if (selectedShipping === 'meetup') {
                shipEmoji = `${fromCP(0x1F91D)} Meetup`; // Handshake
                msg += `\n${shipEmoji}`;
            } else {
                msg += `\n${shipEmoji}`;
            }

            const total = subtotal + shippingCost;
            msg += `\n${fromCP(0x1F4B8)} ${selectedPayment} : ${total}‚Ç¨`; // Money with Wings

            // Save to Backend (Database)
            try {
                const orderData = {
                    items: items,
                    total: total,
                    shippingMethod: selectedShipping,
                    paymentMethod: selectedPayment,
                    carrier: selectedCarrier,
                    userInfo: userInfo,
                    rawMessage: msg,
                    createdAt: new Date().toISOString()
                };



                const headers = { 'Content-Type': 'application/json' };
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData) {
                    headers['x-telegram-init-data'] = window.Telegram.WebApp.initData;
                }

                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(orderData)
                });

                const result = await response.json();
                if (result.success && result.orderId) {
                    // Backend now returns the 4-digit code directly
                    const shortId = result.orderId;
                    msg = `Commande No ${shortId}\n` + msg;


                }
            } catch (e) { console.error("Erreur sauvegarde", e); }

            // Utilisation du format standard pour Telegram avec pr√©-remplissage
            const contactUrl = "https://t.me/FullTerpzExotica";
            // Encodage du message pour l'URL
            const encodedMsg = encodeURIComponent(msg);
            const url = `${contactUrl}?text=${encodedMsg}`;

            // Copy to clipboard fallback + Redirect
            // On copie toujours le message dans le presse-papier par s√©curit√©
            navigator.clipboard.writeText(msg).then(() => {
                showToast("Commande copi√©e ! Collez-la dans Telegram.", "success");
            }).catch(err => console.error('Erreur copie', err));

            if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.openLink) {
                // Telegram WebApp supporte parfois mal le ?text=, mais on essaie quand m√™me
                // Le fallback clipboard est essentiel ici
                window.Telegram.WebApp.openTelegramLink(url);
            } else {
                window.open(url, '_blank');
            }

            // Reset UI
            cartItems = {};
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            updateCartCount();
            window.closeCartPage();
            window.showHome();

            // Reset info
            userInfo = null;
            document.querySelectorAll('#info-page input, #info-page textarea').forEach(i => i.value = '');
            // Reset button style
            const btn = document.getElementById('btn-open-info');
            if (btn) {
                btn.className = "w-full py-3 bg-blue-600/20 border border-blue-500/50 text-blue-400 rounded-xl text-sm font-bold flex items-center justify-center gap-2 ripple-effect";
                btn.innerHTML = `<i class="fas fa-edit"></i> Remplir mes informations`;
            }
        };

        window.hideProduct = () => { productPage.classList.remove('active'); toggleBodyScroll(false); };
        // window.closeCartPage already defined above


        function updateCartCount() { const count = Object.values(cartItems).reduce((a, b) => a + b.quantity, 0); const badge = document.getElementById('cart-badge'); if (count > 0) { badge.classList.remove('hidden'); } else { badge.classList.add('hidden'); } }

        // MODIFI√â: Fonction Toast avec type erreur
        function showToast(txt, type = 'success') {
            const m = document.getElementById('message-modal');
            const icon = type === 'error' ? '<i class="fas fa-times-circle text-red-500"></i>' : '<i class="fas fa-check-circle text-green-500"></i>';
            m.innerHTML = `<div class="bg-white text-black px-6 py-3 rounded-full shadow-2xl font-bold text-sm flex items-center gap-2">${icon}<span>${txt}</span></div>`;
            m.style.opacity = '1'; m.style.transform = 'translate(-50%, 20px)'; setTimeout(() => { m.style.opacity = '0'; m.style.transform = 'translate(-50%, 0px)'; }, 3000);
        }

        window.selectShipping = (val, btn) => {
            selectedShipping = val;
            // Reset Carrier Info
            selectedCarrier = null;
            selectedCarrierCost = 0;

            document.querySelectorAll('.shipping-btn').forEach(b => {
                b.classList.remove('bg-white', 'text-black', 'border-transparent');
                b.classList.add('bg-white/5', 'border-white/10');
            });
            btn.classList.remove('bg-white/5', 'border-white/10');
            btn.classList.add('bg-white', 'text-black', 'border-transparent');

            // Show payment section
            const payCard = document.getElementById('payment-section-card');
            if (payCard) payCard.classList.remove('hidden');

            renderCarriers(val);
            updatePaymentMethods(val);
            renderCart(); // Re-render to update total (reset shipping cost)

            // Scroll Logic
            setTimeout(() => {
                const target = document.getElementById('delivery-carrier-container');
                const paymentTarget = document.getElementById('payment-section-card');

                if (target && !target.classList.contains('hidden')) {
                    target.style.scrollMarginTop = '140px';
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else if (paymentTarget) {
                    paymentTarget.style.scrollMarginTop = '140px';
                    paymentTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }


        window.selectCarrier = (type, cost, btn) => {
            selectedCarrier = type;
            selectedCarrierCost = parseFloat(cost) || 0;
            document.querySelectorAll('.carrier-btn').forEach(b => {
                b.classList.remove('bg-white', 'text-black', 'border-transparent');
                b.classList.add('bg-white/5', 'border-white/10');
            });
            btn.classList.remove('bg-white/5', 'border-white/10');
            btn.classList.add('bg-white', 'text-black', 'border-transparent');
            renderCart();
        }

        function updatePaymentMethods(shippingType) {
            const container = document.getElementById('payment-methods-container');
            if (!container) return;
            container.innerHTML = '';
            selectedPayment = null;

            // Use Settings or Defaults
            // FIXED: Force new payment methods (Ignore Backend for now to ensure update)
            const allMethods = {
                "delivery": [
                    { label: 'üí∂ Cash', value: 'Cash' }
                ],
                "shipping": [],
                "meetup": []
            };

            let options = allMethods[shippingType] || [];

            // Style adjustment
            if (options.length <= 2) {
                container.className = 'grid grid-cols-2 gap-2';
            } else {
                container.className = 'grid grid-cols-2 gap-2'; // Force grid for all
            }

            options.forEach((opt, index) => {
                const btn = document.createElement('button');
                btn.className = 'payment-btn w-full py-3 bg-white/5 border border-white/10 rounded-xl text-sm font-medium transition-all';

                // Si nombre impair, le dernier prend toute la largeur
                if (index === options.length - 1 && options.length % 2 !== 0) {
                    btn.classList.add('col-span-2');
                }

                btn.textContent = opt.label;
                btn.onclick = () => selectPayment(opt.value, btn);
                container.appendChild(btn);
            });
        }

        // --- DYNAMIC RENDER FUNCTIONS ---

        function renderShippingOptions() {
            const container = document.getElementById('shipping-options-container');
            if (!container) return;
            container.innerHTML = '';

            // FIXED: Force new shipping options
            const opts = [
                { name: "Livraison", type: "delivery" }
            ];

            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'shipping-btn flex-1 py-3 bg-white/5 border border-white/10 rounded-xl text-sm font-medium transition-all';
                let icon = 'üì¶ ';
                if (opt.type === 'delivery') icon = 'üèéÔ∏è ';
                if (opt.type === 'meetup') icon = 'ü§ù ';
                btn.textContent = icon + opt.name;
                btn.onclick = () => selectShipping(opt.type, btn);
                container.appendChild(btn);
            });
        }

        function renderCarriers(shippingType) {
            const container = document.getElementById('carrier-options-container');
            if (!container) return;
            container.innerHTML = '';

            const allCarriers = {
                "shipping": [{ name: "Mondial Relay", price: 25 }],
                "delivery": [],
                "meetup": []
            };



            if (carriers.length > 0) {
                container.classList.remove('hidden');
                container.className = 'flex gap-2 mb-3';

                carriers.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = 'carrier-btn flex-1 py-3 bg-white/5 border border-white/10 rounded-xl text-sm font-medium transition-all';
                    btn.textContent = `${c.name} : ${c.price}‚Ç¨`;
                    btn.onclick = () => selectCarrier(c.name, c.price, btn);
                    container.appendChild(btn);
                });
            } else {
                container.classList.add('hidden');
            }

            const parent = document.getElementById('delivery-carrier-container');
            if (parent) {
                // Show if carriers exist OR if delivery type (to access Info button)
                if (carriers.length > 0 || shippingType === 'delivery') {
                    parent.classList.remove('hidden');
                } else {
                    parent.classList.add('hidden');
                }
            }
        }
        window.selectPayment = (val, btn) => { selectedPayment = val; document.querySelectorAll('.payment-btn').forEach(b => { b.classList.remove('bg-white', 'text-black', 'border-transparent'); b.classList.add('bg-white/5', 'border-white/10'); }); btn.classList.remove('bg-white/5', 'border-white/10'); btn.classList.add('bg-white', 'text-black', 'border-transparent'); }
        // Open Contact Modal
        window.openContactModal = () => {
            const m = document.getElementById('contact-modal-overlay');
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0'); m.querySelector('.transform').classList.remove('scale-95'); }, 10);

            // Dynamic Links from data.json if available, or fallback
            // We update DOM elements here just in case they were static

            // Update Private Discussion Link
            const privBtn = document.getElementById('contact-private-btn');
            if (privBtn) privBtn.href = "https://t.me/FullTerpzExotica";
        };

        window.closeContactModal = () => {
            const m = document.getElementById('contact-modal-overlay');
            m.classList.add('opacity-0'); m.querySelector('.transform').classList.add('scale-95');
            setTimeout(() => m.classList.add('hidden'), 300);
        };

        // MODIFI√â: Gestion liens externes
        window.openExternalLink = (url) => {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.openLink(url);
            } else {
                const newWindow = window.open(url, '_blank');
                if (newWindow) {
                    newWindow.focus();
                } else {
                    location.href = url;
                }
            }
        };

        // initHeaderCarousel removed in favor of 3D Banner




        // --- RESTORED CART FUNCTIONS ---

        window.selectShipping = (val, btn) => {
            selectedShipping = val;
            // Reset Carrier Info
            selectedCarrier = null;
            selectedCarrierCost = 0;

            document.querySelectorAll('.shipping-btn').forEach(b => {
                b.classList.remove('bg-white', 'text-black', 'border-transparent');
                b.classList.add('bg-white/5', 'border-white/10');
            });
            btn.classList.remove('bg-white/5', 'border-white/10');
            btn.classList.add('bg-white', 'text-black', 'border-transparent');

            // Show payment section
            const payCard = document.getElementById('payment-section-card');
            if (payCard) payCard.classList.remove('hidden');

            renderCarriers(val);
            updatePaymentMethods(val);
            renderCart(); // Re-render to update total (reset shipping cost)

            // Scroll Logic
            setTimeout(() => {
                const target = document.getElementById('delivery-carrier-container');
                const paymentTarget = document.getElementById('payment-section-card');

                if (target && !target.classList.contains('hidden')) {
                    target.style.scrollMarginTop = '140px';
                    target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                } else if (paymentTarget) {
                    paymentTarget.style.scrollMarginTop = '140px';
                    paymentTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        window.selectCarrier = (type, cost, btn) => {
            selectedCarrier = type;
            selectedCarrierCost = parseFloat(cost) || 0;
            document.querySelectorAll('.carrier-btn').forEach(b => {
                b.classList.remove('bg-white', 'text-black', 'border-transparent');
                b.classList.add('bg-white/5', 'border-white/10');
            });
            btn.classList.remove('bg-white/5', 'border-white/10');
            btn.classList.add('bg-white', 'text-black', 'border-transparent');
            renderCart();
        }





        function renderCarriers(shippingType) {
            const container = document.getElementById('carrier-options-container');
            if (!container) return;
            container.innerHTML = '';

            const allCarriers = {
                "shipping": [{ name: "Mondial Relay", price: 25 }],
                "delivery": [],
                "meetup": []
            };

            const carriers = allCarriers[shippingType] || [];

            if (carriers.length > 0) {
                container.classList.remove('hidden');
                container.className = 'flex gap-2 mb-3';

                carriers.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = 'carrier-btn flex-1 py-3 bg-white/5 border border-white/10 rounded-xl text-sm font-medium transition-all';
                    btn.textContent = `${c.name} : ${c.price}‚Ç¨`;
                    btn.onclick = () => selectCarrier(c.name, c.price, btn);
                    container.appendChild(btn);
                });
            } else {
                container.classList.add('hidden');
            }

            const parent = document.getElementById('delivery-carrier-container');
            if (parent) {
                // Show if carriers exist OR if delivery type (to access Info button)
                if (carriers.length > 0 || shippingType === 'delivery') {
                    parent.classList.remove('hidden');
                } else {
                    parent.classList.add('hidden');
                }
            }
        }

        window.selectPayment = (val, btn) => {
            selectedPayment = val;
            document.querySelectorAll('.payment-btn').forEach(b => {
                b.classList.remove('bg-white', 'text-black', 'border-transparent');
                b.classList.add('bg-white/5', 'border-white/10');
            });
            btn.classList.remove('bg-white/5', 'border-white/10');
            btn.classList.add('bg-white', 'text-black', 'border-transparent');
        }




        // CONTACT MODAL FUNCTIONS
        window.openContactModal = function () {
            // Populate contact info from appSettings
            if (appSettings && appSettings.contact) {
                const logo = document.getElementById('contact-logo');
                const title = document.getElementById('contact-title');
                const subtitle = document.getElementById('contact-subtitle');
                const buttonsContainer = document.getElementById('contact-buttons-container');

                // Set logo
                if (logo) logo.src = APP_LOGO;

                // Set title and subtitle
                if (title) title.textContent = appSettings.contact.headerTitle || appSettings.appTitle || 'Jefe Cali Delivery';
                if (subtitle) subtitle.textContent = 'Support 7j/7 - R√©ponse rapide';

                //Render contact buttons
                if (buttonsContainer && appSettings.contact.buttons) {
                    buttonsContainer.innerHTML = '';
                    appSettings.contact.buttons.forEach(btn => {
                        const buttonEl = document.createElement('a');
                        buttonEl.href = btn.url;
                        buttonEl.target = '_blank';
                        buttonEl.className = 'contact-card-custom p-4 rounded-xl flex items-center gap-4 transition-all hover:scale-[1.02] active:scale-95';
                        buttonEl.style.borderColor = btn.color || '#3b82f6';

                        const icon = btn.url.includes('t.me') ? 'fab fa-telegram' :
                            btn.url.includes('instagram') ? 'fab fa-instagram' :
                                btn.url.includes('signal') ? 'fas fa-comment' : 'fas fa-link';

                        buttonEl.innerHTML = `
                            <div class="w-12 h-12 rounded-full flex items-center justify-center" style="background: ${btn.color || '#3b82f6'};">
                                <i class="${icon} text-white text-xl"></i>
                            </div>
                            <div class="flex-1">
                                <div class="text-white font-bold text-sm">${btn.label}</div>
                                <div class="text-gray-400 text-xs">${btn.url.includes('t.me') ? 'Discussion priv√©e' : btn.url.includes('instagram') ? 'Instagram' : 'Contact'}</div>
                            </div>
                            <i class="fas fa-chevron-right text-gray-600"></i>
                        `;
                        buttonsContainer.appendChild(buttonEl);
                    });
                }
            }

            const overlay = document.getElementById('contact-modal-overlay');
            const sheet = document.getElementById('contact-sheet'); // Legacy sheet selector just in case, though structure is centered modal
            const modalContent = overlay.querySelector('.contact-card-custom'); // Get the modal card

            overlay.classList.remove('hidden');
            overlay.classList.remove('pointer-events-none'); // ENABLE CLICKS
            setTimeout(() => {
                overlay.classList.remove('opacity-0');
                if (sheet) sheet.classList.remove('translate-y-full'); // Not used for this centered modal style but good for safety
                if (modalContent) modalContent.style.transform = 'scale(1)';
            }, 10);
        };

        window.closeContactModal = function () {
            const overlay = document.getElementById('contact-modal-overlay');
            const sheet = document.getElementById('contact-sheet');
            const modalContent = overlay.querySelector('.contact-card-custom');

            overlay.classList.add('opacity-0');
            overlay.classList.add('pointer-events-none'); // DISABLE CLICKS
            if (sheet) sheet.classList.add('translate-y-full');
            if (modalContent) modalContent.style.transform = 'scale(0.90)';

            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 300);
        };



        // --- SCROLL LOCK HELPER ---
        function toggleBodyScroll(lock) {
            if (lock) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        document.addEventListener('click', function (e) { const target = e.target.closest('.ripple-effect'); if (target) { const rect = target.getBoundingClientRect(); const ripple = document.createElement('span'); ripple.className = 'ripple-span'; ripple.style.width = ripple.style.height = Math.max(rect.width, rect.height) + 'px'; ripple.style.left = e.clientX - rect.left - rect.width / 2 + 'px'; ripple.style.top = e.clientY - rect.top - rect.height / 2 + 'px'; target.appendChild(ripple); setTimeout(() => ripple.remove(), 600); } });


    </script>
</body>

</html>